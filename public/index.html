<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HHM - Admin Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <link href="/css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
       @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap');

:root {
    --pink-panther-lightest: #FFF0F5; /* Lavender Blush - for very light backgrounds */
    --pink-panther-light: #FFDDF4;    /* Pink Lace - for lighter backgrounds, accents */
    --pink-panther-medium: #FFB6C1;   /* LightPink - for secondary elements, borders */
    --pink-panther-main: #F580C8;     /* Persian Pink - primary interactive elements */
    --pink-panther-dark: #E53888;     /* Mexican Pink - darker accents, gradients */
    --pink-panther-darker: #B92E7E;   /* A bit darker than Mexican Pink for text/strong accents */

    --pink-panther-text-on-dark: #FFFFFF;
    --pink-panther-text-on-light: #A32E6F; /* Dark pink for text on light pink/white */
    --pink-panther-text-on-light-muted: #B05C8B; /* Muted version for less emphasis */

    --pink-panther-shadow-main: rgba(245, 128, 200, 0.3);
    --pink-panther-shadow-medium: rgba(255, 182, 193, 0.3);
    --pink-panther-shadow-light: rgba(255, 221, 244, 0.2);

    --pink-panther-ring-main: rgba(245, 128, 200, 0.3); /* For focus rings */
    
    --pink-panther-transparent-light: rgba(255, 221, 244, 0.7); /* For hover states on tables */
    --pink-panther-transparent-lighter: rgba(255, 240, 245, 0.7); /* For very subtle hover */
}
        
body {
    font-family: 'Quicksand', sans-serif;
    background-color: var(--pink-panther-lightest);  /* Changed from #f5f5f5 */
}

/* Sidebar already updated by user, using variables for consistency */
.sidebar { 
    background: linear-gradient(135deg, var(--pink-panther-main) 0%, var(--pink-panther-dark) 100%); 
}
.card { 
    background: rgba(255, 255, 255, 0.9); /* Stays white/translucent */
    backdrop-filter: blur(10px); 
    border-radius: 15px; 
    box-shadow: 0 4px 15px var(--pink-panther-shadow-light); /* Subtle pink shadow */
    transition: all 0.3s ease; 
}
.card:hover { 
    transform: translateY(-5px); 
    box-shadow: 0 10px 20px var(--pink-panther-shadow-medium); 
}
.book-cover { /* Used on dashboard top selling */
    background: linear-gradient(135deg, var(--pink-panther-light) 0%, var(--pink-panther-medium) 100%); 
    box-shadow: 0 4px 10px var(--pink-panther-shadow-light); 
}
.lofi-bg { /* This is applied to body for login page */
    background-color: var(--pink-panther-lightest); /* Ensure consistency */
}
.btn-primary { 
    background: linear-gradient(135deg, var(--pink-panther-main) 0%, var(--pink-panther-dark) 100%); 
    color: var(--pink-panther-text-on-dark); 
    transition: all 0.3s ease; 
}
.btn-primary:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 5px 15px var(--pink-panther-shadow-main); 
}
.btn-secondary { 
    background: linear-gradient(135deg, var(--pink-panther-light) 0%, var(--pink-panther-medium) 100%); 
    color: var(--pink-panther-text-on-light);
    transition: all 0.3s ease; 
}
.btn-secondary:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 5px 15px var(--pink-panther-shadow-medium); 
}
.nav-link { 
    transition: all 0.3s ease; 
    /* Text color for nav links in sidebar is often set by Tailwind (e.g., text-gray-300). 
       This can be overridden here or by changing Tailwind class. Assuming white/light text on dark pink. */
    color: rgba(255, 255, 255, 0.85); /* Light text for sidebar links */
}
.nav-link:hover { 
    background-color: rgba(255, 255, 255, 0.1); /* Keeps light overlay on pink */
    transform: translateX(5px); 
    color: var(--pink-panther-text-on-dark);
}
.nav-link.active { 
    background-color: rgba(255, 255, 255, 0.2); /* Keeps light overlay on pink */
    border-left: 4px solid var(--pink-panther-text-on-dark); /* White border */
    color: var(--pink-panther-text-on-dark);
}
.table-row:hover { 
    background-color: var(--pink-panther-transparent-light); 
}
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { 
    background: var(--pink-panther-lightest); 
    border-radius: 10px; 
}
::-webkit-scrollbar-thumb { 
    background: var(--pink-panther-medium); 
    border-radius: 10px; 
}
::-webkit-scrollbar-thumb:hover { 
    background: var(--pink-panther-main); 
}

.content-panel { display: none; }
.content-panel.active { display: block; }

.notification-dot { display: none; }
.notification-dot.visible { display: block; }
#notification-popup { transition: opacity 0.3s ease, transform 0.3s ease; }
.notification-item { padding: 0.75rem 1rem; cursor: default; transition: background-color 0.2s ease; }
.notification-item:hover { background-color: var(--pink-panther-transparent-lighter); }
.notification-item .notification-headline { font-size: 0.875rem; line-height: 1.25rem; color: var(--pink-panther-darker); }
.notification-item .notification-message { font-size: 0.8rem; line-height: 1.15rem; color: var(--pink-panther-text-on-light); margin-top: 0.125rem; }
.notification-item .notification-timestamp { font-size: 0.7rem; color: var(--pink-panther-text-on-light-muted); margin-top: 0.25rem; }
.notification-item .mark-as-read-btn { font-size: 0.75rem; color: var(--pink-panther-main); margin-top: 0.375rem; display: inline-block; }
.notification-item .mark-as-read-btn:hover { text-decoration: underline; color: var(--pink-panther-dark); }
.notification-item.read { background-color: var(--pink-panther-lightest); }
.notification-item.read .notification-headline, 
.notification-item.read .notification-message { font-weight: normal; color: var(--pink-panther-text-on-light-muted); }
.notification-item.read .mark-as-read-btn { color: var(--pink-panther-medium); cursor: default; text-decoration: none; }
.notification-item.read .mark-as-read-btn:hover { text-decoration: none; }
.notification-item.unread .notification-headline { font-weight: 500; }
.notification-item.unread { background-color: #ffffff; } /* Keep unread distinct on white */

#toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1050; display: flex; flex-direction: column; gap: 10px; }
.toast { padding: 12px 20px; border-radius: 8px; color: white; font-size: 0.9rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; }
.toast.show { opacity: 1; transform: translateY(0); }
/* Toast specific colors might remain as is or be themed */
.toast.success { background-color: #28a745; } /* Or a success pink */
.toast.error { background-color: #dc3545; }   /* Or an error pink/red */
.toast.info { background-color: var(--pink-panther-dark); } /* Info can be pink */

.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
.modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid var(--pink-panther-medium); width: 80%; max-width: 600px; border-radius: 10px; position: relative; }
.modal-close { color: var(--pink-panther-medium); float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
.modal-close:hover, .modal-close:focus { color: var(--pink-panther-dark); text-decoration: none; cursor: pointer; }

/* Login Page Specific Styles */
#login-page-wrapper {
    background-color: var(--pink-panther-lightest); /* lofi-bg */
}
.login-input {
    appearance: none;
    border: 1px solid var(--pink-panther-medium); 
    border-radius: 0.5rem; 
    padding: 0.75rem 1rem; 
    width: 100%;
    font-size: 0.875rem; 
    color: var(--pink-panther-text-on-light); 
    transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}
.login-input:focus {
    outline: none;
    border-color: var(--pink-panther-main); 
    box-shadow: 0 0 0 2px var(--pink-panther-ring-main); 
}
/* Ensure placeholder text is also themed if needed (browser specific) */
.login-input::placeholder {
    color: var(--pink-panther-medium);
    opacity: 0.7;
}

#dashboard-wrapper .fixed-header {
    position: fixed;
    top: 0;
    right: 0; 
    background-color: white; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
    z-index: 40; 
    width: 100%; 
}
@media (min-width: 768px) { 
    #dashboard-wrapper .fixed-header {
         width: calc(100% - 16rem); 
         left: 16rem; 
    }
}
#dashboard-wrapper .content-area {
    padding-top: 100px; 
}

/* Reports Panel */
#reports-panel #analytics-content-wrapper * { box-sizing: border-box; }
#reports-panel #analytics-content-wrapper .dashboard { max-width: 1400px; margin: 0 auto; }
#reports-panel #analytics-content-wrapper .header {
    text-align: center;
    margin-bottom: 30px;
    color: var(--pink-panther-darker); 
}
#reports-panel #analytics-content-wrapper .header h1 { font-size: 2.0rem; margin-bottom: 10px; }
#reports-panel #analytics-content-wrapper .kpi-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
#reports-panel #analytics-content-wrapper .kpi-card {
    background: rgba(255, 255, 255, 0.9); 
    backdrop-filter: blur(5px); 
    border-radius: 15px; 
    padding: 20px; 
    text-align: center;
    box-shadow: 0 4px 15px var(--pink-panther-shadow-light); 
    border: 1px solid var(--pink-panther-light); 
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}
#reports-panel #analytics-content-wrapper .kpi-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px var(--pink-panther-shadow-medium); 
}
#reports-panel #analytics-content-wrapper .kpi-value {
    font-size: 2.2rem; 
    font-weight: bold;
    color: var(--pink-panther-darker); 
    margin-bottom: 8px;
}
#reports-panel #analytics-content-wrapper .kpi-label {
    font-size: 1.0rem; 
    color: var(--pink-panther-text-on-light); 
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
/* KPI specific colors - can be pink variants or keep distinct */
#reports-panel #analytics-content-wrapper .kpi-card.revenue .kpi-value { color: #F580C8; } /* Main Pink */
#reports-panel #analytics-content-wrapper .kpi-card.books .kpi-value { color: #E53888; } /* Dark Pink */
#reports-panel #analytics-content-wrapper .kpi-card.orders .kpi-value { color: #FFB6C1; } /* Medium Pink */
#reports-panel #analytics-content-wrapper .kpi-card.customers .kpi-value { color: #FFDDF4; } /* Light Pink */

#reports-panel #analytics-content-wrapper .charts-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
#reports-panel #analytics-content-wrapper .chart-container {
    background: rgba(255, 255, 255, 0.9); 
    backdrop-filter: blur(5px);
    border-radius: 15px;
    padding: 20px 20px 50px 20px;
    box-shadow: 0 4px 15px var(--pink-panther-shadow-light);
    border: 1px solid var(--pink-panther-light);
    height: 400px; 
    position: relative; 
}
#reports-panel #analytics-content-wrapper .chart-title {
    font-size: 1.2rem; 
    font-weight: bold;
    color: var(--pink-panther-darker);
    margin-bottom: 15px;
    text-align: center;
}
#reports-panel #analytics-content-wrapper .full-width { grid-column: 1 / -1; }
#reports-panel #analytics-content-wrapper .orders-section {
    background: rgba(255, 255, 255, 0.9); 
    backdrop-filter: blur(5px);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 4px 15px var(--pink-panther-shadow-light);
    border: 1px solid var(--pink-panther-light);
    margin-bottom: 20px;
}
#reports-panel #analytics-content-wrapper .orders-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
#reports-panel #analytics-content-wrapper .orders-table th,
#reports-panel #analytics-content-wrapper .orders-table td {
    padding: 10px 12px; 
    text-align: left;
    border-bottom: 1px solid var(--pink-panther-light); 
}
#reports-panel #analytics-content-wrapper .orders-table th {
    background-color: var(--pink-panther-lightest); 
    font-weight: 600;
    color: var(--pink-panther-darker); 
}
#reports-panel #analytics-content-wrapper .orders-table tr:hover td {
     background-color: var(--pink-panther-transparent-light); 
}
#reports-panel #analytics-content-wrapper .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; display: inline-block; }
/* Status badges - adjust to pink theme or keep for clarity */
#reports-panel #analytics-content-wrapper .status-completed { background-color: #FFDDF4; color: var(--pink-panther-darker); } /* Light Pink BG, Dark Pink Text */
#reports-panel #analytics-content-wrapper .status-pending { background-color: #FFB6C1; color: var(--pink-panther-darker); }   /* Medium Pink BG, Dark Pink Text */
#reports-panel #analytics-content-wrapper .status-processing { background-color: #F580C8; color: var(--pink-panther-text-on-dark); } /* Main Pink BG, White text */
#reports-panel #analytics-content-wrapper .status-shipped { background-color: var(--pink-panther-dark); color: var(--pink-panther-text-on-dark); } /* Dark Pink BG, White text */
#reports-panel #analytics-content-wrapper .status-cancelled { background-color: #FFC0CB; color: #701C4A; } /* Pink BG, Very Dark Pink/Reddish text */

#reports-panel #analytics-content-wrapper .refresh-btn {
    background: linear-gradient(135deg, var(--pink-panther-main) 0%, var(--pink-panther-dark) 100%);
    color: var(--pink-panther-text-on-dark);
    border: none; padding: 10px 20px; border-radius: 0.5rem; cursor: pointer;
    font-size: 0.9rem; font-weight: 500; transition: all 0.3s ease; margin-bottom: 20px;
}
#reports-panel #analytics-content-wrapper .refresh-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px var(--pink-panther-shadow-main); 
}
#reports-panel #analytics-content-wrapper .loading {
    text-align: center; color: var(--pink-panther-text-on-light-muted); font-style: italic; padding: 20px;
}
#reports-panel #analytics-content-wrapper .error { /* Keep error distinct */
    color: #EF4444; text-align: center; padding: 15px; background-color: #FEE2E2; 
    border: 1px solid #FCA5A5; border-radius: 8px; margin: 10px 0;
}
@media (max-width: 768px) {
    #reports-panel #analytics-content-wrapper .charts-section { grid-template-columns: 1fr; }
    #reports-panel #analytics-content-wrapper .kpi-section { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    #reports-panel #analytics-content-wrapper .header h1 { font-size: 1.75rem; }
}

/* Notification Panel Rows */
.notification-inbox-item { transition: background-color 0.15s ease-in-out; }
.notification-inbox-item.unread .headline { font-weight: 600; color: var(--pink-panther-darker); }
.notification-inbox-item.read .headline { font-weight: normal; color: var(--pink-panther-text-on-light-muted); }
.notification-inbox-item.read { background-color: var(--pink-panther-lightest); }
.notification-inbox-item:hover { background-color: var(--pink-panther-transparent-light); }
.notification-inbox-item.active-notification-row,
.notification-inbox-item.active-notification-row:hover {
    background-color: var(--pink-panther-light); 
    border-left-width: 4px;
    border-left-color: var(--pink-panther-main); 
    padding-left: calc(0.75rem - 4px); 
}
.notification-inbox-item .notification-actions { opacity: 0; transition: opacity 0.2s ease-in-out; }
.notification-inbox-item:hover .notification-actions,
.notification-inbox-item.active-notification-row .notification-actions { opacity: 1; }

.custom-scrollbar::-webkit-scrollbar { width: 6px; }
.custom-scrollbar::-webkit-scrollbar-track { background: var(--pink-panther-lightest); border-radius: 3px;}
.custom-scrollbar::-webkit-scrollbar-thumb { background: var(--pink-panther-medium); border-radius: 3px;}
.custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--pink-panther-main); }

#notification-detail-view-area .prose { font-size: 0.875rem; }
#notification-detail-view-area .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }

/* Books Panel View Toggle Active State */
#books-view-compact-btn.active-view-btn, 
#books-view-cozy-btn.active-view-btn {
    background-color: var(--pink-panther-medium); 
    color: var(--pink-panther-text-on-dark); 
}
.book-cover-cozy {
    border-radius: 0.375rem; 
}
#books-list-container .card {
    width: 100%;
}

/* General text color for elements not explicitly panel white based on Tailwind */
/* These are broad. You might need more specific selectors or adjust Tailwind classes. */
.text-gray-800 { color: var(--pink-panther-darker) !important; }
.text-gray-700 { color: var(--pink-panther-text-on-light) !important; }
.text-gray-600 { color: var(--pink-panther-text-on-light-muted) !important; }
.text-gray-500 { color: var(--pink-panther-medium) !important; } /* For less important text */

/* Borders */
.border-gray-300 { border-color: var(--pink-panther-medium) !important; }
.border-gray-200 { border-color: var(--pink-panther-light) !important; }

/* Header Icons (example, if Tailwind class text-gray-600 is used and not overridden) */
#main-content-title { color: var(--pink-panther-darker); }
#refresh-data-button, #notification-bell-button { color: var(--pink-panther-text-on-light); }
#refresh-data-button:hover, #notification-bell-button:hover { color: var(--pink-panther-dark); }
#global-search-input { 
    border-color: var(--pink-panther-medium); 
    color: var(--pink-panther-text-on-light);
}
#global-search-input:focus {
    border-color: var(--pink-panther-main);
    box-shadow: 0 0 0 2px var(--pink-panther-ring-main);
}
#global-search-input + i.fa-search { color: var(--pink-panther-medium); }


/* Sidebar Admin User Info */
.sidebar .text-gray-300 { /* Example: "Admin" subtitle for user */
    color: rgba(255, 255, 255, 0.7) !important;
}
.sidebar .text-gray-400 { /* Example: "Settings" uppercase label */
    color: rgba(255, 255, 255, 0.6) !important;
}

/* Ensure mobile nav text color is also whiteish on pink */
.mobile-nav .mobile-nav-link { color: rgba(255, 255, 255, 0.85); }
.mobile-nav .mobile-nav-link.active, 
.mobile-nav .mobile-nav-link:hover { color: var(--pink-panther-text-on-dark); }
.mobile-nav { background-color: var(--pink-panther-dark); } /* Match sidebar gradient end */

/* Store settings labels */
#store-settings-panel label { color: var(--pink-panther-text-on-light); }
#store-settings-panel input {
    border-color: var(--pink-panther-medium);
    color: var(--pink-panther-text-on-light);
}
#store-settings-panel input:focus {
    border-color: var(--pink-panther-main);
    box-shadow: 0 0 0 2px var(--pink-panther-ring-main);
}

/* Admin users panel labels */
#admin-users-panel label { color: var(--pink-panther-text-on-light); }
#admin-users-panel input {
    border-color: var(--pink-panther-medium);
    color: var(--pink-panther-text-on-light);
}
#admin-users-panel input:focus {
    border-color: var(--pink-panther-main);
    box-shadow: 0 0 0 2px var(--pink-panther-ring-main);
}
/* Admin users table */
#admin-users-panel table th { color: var(--pink-panther-darker); }
#admin-users-panel table td { color: var(--pink-panther-text-on-light); }
#admin-users-panel table button.text-blue-500 { color: var(--pink-panther-main) !important; }
#admin-users-panel table button.text-blue-500:hover { color: var(--pink-panther-dark) !important; }
/* Delete button already btn-danger - if you want a pink danger: */
/* .btn-danger { background-color: var(--pink-panther-dark); color: white; } */
    </style>
</head>
<body class="lofi-bg">
    <div id="toast-container"></div>

    <div id="login-page-wrapper" class="min-h-screen flex items-center justify-center p-4">
        <div class="card p-8 sm:p-10 w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fas fa-book-open text-5xl text-gray-600"></i>
                <h1 class="text-3xl font-bold text-gray-700 mt-3">HHM Books</h1>
                <p class="text-gray-500 text-md">Admin Login</p>
            </div>
            <form id="loginForm">
                <div class="mb-6">
                    <label for="loginEmail" class="block text-gray-700 text-sm font-medium mb-2">Email Address</label>
                    <input type="email" id="loginEmail" name="email" required class="login-input font-semibold" placeholder="admin@m.com">
                </div>
                <div class="mb-8">
                    <label for="loginPassword" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                    <input type="password" id="loginPassword" name="password" required class="login-input" placeholder="••••••••">
                </div>
                <button type="submit" class="btn-primary w-full py-3 rounded-lg text-lg font-semibold">
                    Login
                </button>
            </form>
        </div>
    </div>

    <div id="dashboard-wrapper" class="hidden">
        <div class="flex h-screen overflow-hidden">
            <div class="sidebar w-64 text-white flex-shrink-0 hidden md:flex md:flex-col">
                <div class="p-6">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-book-open text-2xl"></i>
                        <h1 class="text-xl font-bold">HHM Books</h1>
                    </div>
                    <p class="text-gray-300 text-sm mt-1">Admin Dashboard</p>
                </div>
                <nav class="mt-8 main-nav flex-grow">
                     <a href="#" data-target="dashboard-panel" class="nav-link active flex items-center px-6 py-3 text-white">
                        <i class="fas fa-tachometer-alt mr-3"></i>
                        Dashboard
                    </a>
                    <a href="#" data-target="books-panel" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:text-white">
                        <i class="fas fa-book mr-3"></i>
                        Books
                    </a>
                    <a href="#" data-target="customers-panel" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:text-white">
                        <i class="fas fa-users mr-3"></i>
                        Customers
                    </a>
                    <a href="#" data-target="orders-panel" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:text-white">
                        <i class="fas fa-shopping-cart mr-3"></i>
                        Orders
                    </a>
                    <a href="#" data-target="genres-panel" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:text-white">
                        <i class="fas fa-tags mr-3"></i>
                        Genres
                    </a>
                     <a href="#" data-target="authors-panel" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:text-white">
                        <i class="fas fa-feather-alt mr-3"></i>
                        Authors
                    </a>
                     <a href="#" data-target="publishers-panel" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:text-white">
                        <i class="fas fa-building mr-3"></i>
                        Publishers
                    </a>
                    <a href="#" data-target="reports-panel" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:text-white">
                        <i class="fas fa-chart-line mr-3"></i>
                        Reports
                    </a>
                    <a href="#" data-target="notifications-panel-page" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:text-white">
                        <i class="fas fa-inbox mr-3"></i> <!-- Changed icon to fa-inbox, or use fa-bell -->
                        Notifications
                    </a>

                    <div class="px-6 mt-6 mb-6">
                        <p class="text-gray-400 uppercase text-xs font-semibold tracking-wider">Settings</p>
                    </div>
                    <a href="#" data-target="store-settings-panel" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:text-white">
                        <i class="fas fa-cog mr-3"></i>
                        Store Settings
                    </a>
                    <a href="#" data-target="admin-users-panel" class="nav-link flex items-center px-6 py-3 text-gray-300 hover:text-white">
                        <i class="fas fa-user-shield mr-3"></i>
                        Admin Users
                    </a>
                </nav>
                <div class="p-6">
                    <div class="flex items-center">
                        <img src="https://randomuser.me/api/portraits/women/44.jpg" class="w-10 h-10 rounded-full" alt="Admin">
                        <div class="ml-3">
                            <p class="text-white font-medium">Sarah Johnson</p>
                            <p class="text-gray-300 text-sm">Admin</p>
                        </div>
                        <button id="logout-button" title="Logout" class="ml-auto text-gray-300 hover:text-white pl-3"> 
                            <i class="fas fa-sign-out-alt text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="md:hidden fixed bottom-0 left-0 right-0 bg-gray-800 text-white z-50">
                <div class="flex justify-around mobile-nav">
                    <a href="#" data-target="dashboard-panel" class="p-4 text-center mobile-nav-link"><i class="fas fa-tachometer-alt block text-xl"></i><span class="text-xs mt-1 block">Dashboard</span></a>
                    <a href="#" data-target="books-panel" class="p-4 text-center mobile-nav-link"><i class="fas fa-book block text-xl"></i><span class="text-xs mt-1 block">Books</span></a>
                    <a href="#" data-target="orders-panel" class="p-4 text-center mobile-nav-link"><i class="fas fa-shopping-cart block text-xl"></i><span class="text-xs mt-1 block">Orders</span></a>
                     <a href="#" data-target="customers-panel" class="p-4 text-center mobile-nav-link"><i class="fas fa-users block text-xl"></i><span class="text-xs mt-1 block">Customers</span></a>
                </div>
            </div>
            
            <div class="flex-1 flex flex-col overflow-hidden">
                <header class="fixed-header">
                    <div class="flex items-center justify-between px-6 py-4">
                        <div class="flex items-center">
                            <button class="md:hidden mr-4 text-gray-600" id="mobile-menu-button"><i class="fas fa-bars text-xl"></i></button>
                            <h2 id="main-content-title" class="text-xl font-semibold text-gray-800">Dashboard</h2>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button id="refresh-data-button" title="Refresh Data" class="text-gray-600 hover:text-gray-900 focus:outline-none"><i class="fas fa-sync-alt text-xl"></i></button>
                            <div class="relative">
                                <button id="notification-bell-button" class="text-gray-600 hover:text-gray-900 focus:outline-none"><i class="fas fa-bell text-xl"></i></button>
                                <span id="notification-indicator" class="notification-dot absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>
                                <div id="notification-popup" class="hidden absolute right-0 mt-2 w-80 md:w-96 bg-white rounded-md shadow-lg overflow-hidden z-50 border border-gray-200">
                                    <div class="py-2 px-4 flex justify-between items-center border-b border-gray-200"><h3 class="text-md font-semibold text-gray-700">Notifications</h3><button id="mark-all-read-button" class="text-xs text-blue-600 hover:text-blue-800 font-medium focus:outline-none">Mark all as read</button></div>
                                    <ul id="notification-list" class="divide-y divide-gray-100 max-h-80 overflow-y-auto"><li class="p-4 text-center text-sm text-gray-500">Loading notifications...</li></ul>
                                    <div class="p-2 text-center border-t border-gray-200">
                                        <a href="#" id="view-all-notifications-link" class="text-xs text-blue-600 hover:text-blue-800 font-medium">View all notifications</a>
                                    </div>
                                </div>
                            </div>
                            <div class="relative">
                                <input type="text" id="global-search-input" placeholder="Search dashboard..." class="pl-10 pr-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:border-transparent">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                            <div class="md:hidden"><img src="https://randomuser.me/api/portraits/women/44.jpg" class="w-8 h-8 rounded-full" alt="Admin"></div>
                        </div>
                    </div>
                </header>
                
                <main class="p-6 flex-1 overflow-y-auto content-area">
                    <div id="dashboard-panel" class="content-panel active">
                        <!-- ... (Dashboard panel content - no changes) ... -->
                         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="card p-6"><div class="flex items-center justify-between"><div><p class="text-gray-500">Total Books</p><h3 id="total-books-value" class="text-2xl font-bold mt-2">0</h3></div><div class="bg-blue-100 p-3 rounded-full"><i class="fas fa-book text-blue-500 text-xl"></i></div></div></div>
                            <div class="card p-6"><div class="flex items-center justify-between"><div><p class="text-gray-500">Total Orders</p><h3 id="total-orders-value" class="text-2xl font-bold mt-2">0</h3></div><div class="bg-purple-100 p-3 rounded-full"><i class="fas fa-shopping-cart text-purple-500 text-xl"></i></div></div></div>
                            <div class="card p-6"><div class="flex items-center justify-between"><div><p class="text-gray-500">Total Revenue</p><h3 id="total-revenue-value" class="text-2xl font-bold mt-2">$0</h3></div><div class="bg-green-100 p-3 rounded-full"><i class="fas fa-dollar-sign text-green-500 text-xl"></i></div></div></div>
                            <div class="card p-6"><div class="flex items-center justify-between"><div><p class="text-gray-500">New Customers</p><h3 id="new-customers-value" class="text-2xl font-bold mt-2">0</h3></div><div class="bg-yellow-100 p-3 rounded-full"><i class="fas fa-user-plus text-yellow-500 text-xl"></i></div></div></div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                            <div class="card lg:col-span-2 p-6"><div class="flex items-center justify-between mb-6"><h3 class="text-lg font-semibold">Recent Orders</h3><button class="text-sm text-gray-500 hover:text-gray-700" onclick="setActivePanel('orders-panel', 'Orders')">View All</button></div><div class="overflow-x-auto"><table class="w-full"><thead><tr class="text-left text-gray-500 text-sm border-b"><th class="pb-3">Order ID</th><th class="pb-3">Customer</th><th class="pb-3">Date</th><th class="pb-3">Amount</th><th class="pb-3">Status</th><th class="pb-3">Action</th></tr></thead><tbody id="recent-orders-tbody"><tr class="table-row border-b text-sm"><td colspan="6" class="py-4 text-center text-gray-500">Loading recent orders...</td></tr></tbody></table></div></div>
                            <div class="card p-6"><div class="flex items-center justify-between mb-6"><h3 class="text-lg font-semibold">Top Selling Books</h3><button class="text-sm text-gray-500 hover:text-gray-700" onclick="setActivePanel('books-panel', 'Books')">View All</button></div><div id="top-selling-books-container" class="space-y-4"><p class="text-center text-gray-500">Loading top books...</p></div></div>
                        </div>
                        <div id="dashboardOrderDetailsArea" class="card p-6 mb-8 hidden">
                            <!-- Order details will be dynamically inserted here -->
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="card p-6 lg:col-span-2"><h3 class="text-lg font-semibold mb-6">Quick Add New Book (Simplified)</h3><form id="quickAddBookForm"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label class="block text-gray-700 text-sm font-medium mb-2">Title</label><input type="text" name="title" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div><div><label class="block text-gray-700 text-sm font-medium mb-2">Price</label><input type="number" name="price" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div><div class="md:col-span-2"><label class="block text-gray-700 text-sm font-medium mb-2">Stock</label><input type="number" name="stock" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div></div><div class="flex justify-end mt-6 space-x-3"><p class="text-sm text-gray-500 mr-auto">Note: For full details, use the 'Books' panel.</p><button type="button" class="btn-secondary px-6 py-2 rounded-lg" onclick="document.getElementById('quickAddBookForm').reset()">Cancel</button><button type="submit" class="btn-primary px-6 py-2 rounded-lg">Add Book (Basic)</button></div></form></div>
                            <div class="card p-6"><h3 class="text-lg font-semibold mb-6">Quick Actions</h3><div class="space-y-4"><button class="w-full flex items-center btn-primary px-4 py-3 rounded-lg" onclick="setActivePanel('orders-panel', 'Orders'); document.getElementById('toggleCreateOrderFormBtn')?.click();"><i class="fas fa-plus mr-3"></i><span>Create New Order</span></button><button class="w-full flex items-center btn-secondary px-4 py-3 rounded-lg" onclick="showToast('Process Shipments - Not Implemented', 'info')"><i class="fas fa-truck mr-3"></i><span>Process Shipments</span></button><div id="inventory-alert-box" class="bg-blue-50 p-4 rounded-lg mt-6 hidden"><h4 class="font-medium text-blue-800 mb-2">Inventory Alert</h4><p id="inventory-alert-message" class="text-sm text-blue-700 mb-3">Some books are running low on stock.</p><button class="text-sm font-medium text-blue-600 hover:text-blue-800" onclick="setActivePanel('books-panel', 'Books')">View Details</button></div></div></div>
                        </div>
                    </div>
                    <!-- Books Panel -->
                     
                    <div id="books-panel" class="content-panel">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Manage Books</h2>
                        <div class="card p-6">
                            <!-- MODIFIED BUTTONS with View Toggles -->
                            <div class="flex items-center mb-6">
                                <button class="btn-primary px-6 py-2 rounded-lg" onclick="showAddBookForm()">Add New Book</button>
                                <button class="btn-secondary ml-2 px-4 py-2 rounded-lg" onclick="showModifyBookForm()">Modify Book</button>
                                <button class="btn-danger ml-2 px-4 py-2 rounded-lg bg-red-500 text-white" onclick="showDeleteBookForm()">Remove Book</button>
                                <div class="ml-auto flex items-center space-x-1">
                                    <button id="books-view-compact-btn" title="Compact View" class="p-2 rounded hover:bg-gray-200 text-gray-600">
                                        <i class="fas fa-list"></i>
                                    </button>
                                    <button id="books-view-cozy-btn" title="Cozy View" class="p-2 rounded hover:bg-gray-200 text-gray-600">
                                        <i class="fas fa-th-large"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- ADDED Search UI -->
                            <div class="flex mb-4">
                                <select id="books-search-criteria" class="px-4 py-2 border rounded-l-lg bg-white">
                                    <option value="title">Title</option>
                                    <option value="author">Author</option>
                                    <option value="genre">Genre</option>
                                    <option value="id">Book ID</option>
                                </select>
                                <input type="text" id="books-search-query" placeholder="Search Books..." class="flex-1 px-4 py-2 border-t border-b border-gray-300">
                                <button onclick="searchBooks()" class="btn-primary px-4 py-2 rounded-r-lg">Search</button>
                            </div>
                            
                            <div id="addBookFormSectionInBooksPanel" class="hidden mt-6 border-t pt-6">
                                <h3 class="text-lg font-semibold mb-4">Add/Edit Book</h3>
                                <form id="booksPanelAddBookForm">
                                    <input type="hidden" id="bookIdForEdit" name="bookIdForEdit"> <!-- For editing -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div><label for="bookTitle" class="block text-gray-700 text-sm font-medium mb-2">Title <span class="text-red-500">*</span></label><input type="text" id="bookTitle" name="title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                                        <div><label for="bookAuthor" class="block text-gray-700 text-sm font-medium mb-2">Author <span class="text-red-500">*</span></label><select id="bookAuthor" name="authorId" required class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white"><option value="">Loading Authors...</option></select></div>
                                        <div><label for="bookPublisher" class="block text-gray-700 text-sm font-medium mb-2">Publisher <span class="text-red-500">*</span></label><select id="bookPublisher" name="publisherId" required class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white"><option value="">Loading Publishers...</option></select></div>
                                        <div><label for="bookGenre" class="block text-gray-700 text-sm font-medium mb-2">Genre</label><input type="text" id="bookGenre" name="genre" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                                        <div><label for="bookPrice" class="block text-gray-700 text-sm font-medium mb-2">Price <span class="text-red-500">*</span></label><input type="number" id="bookPrice" name="price" step="0.01" min="0" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                                        <div><label for="bookStock" class="block text-gray-700 text-sm font-medium mb-2">Stock <span class="text-red-500">*</span></label><input type="number" id="bookStock" name="stock" min="0" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                                        <div><label for="bookFormat" class="block text-gray-700 text-sm font-medium mb-2">Format <span class="text-red-500">*</span></label><select id="bookFormat" name="format" required class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white"><option value="">Select Format</option><option value="Paperback">Paperback</option><option value="Hardcover">Hardcover</option><option value="eBook">eBook</option></select></div>
                                        <div><label for="bookLanguage" class="block text-gray-700 text-sm font-medium mb-2">Language</label><input type="text" id="bookLanguage" name="language" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                                        <!-- New Fields for ISBN and BookCover -->
                                        <div><label for="bookISBN" class="block text-gray-700 text-sm font-medium mb-2">ISBN</label><input type="text" id="bookISBN" name="isbn" class="w-full px-4 py-2 border border-gray-300 rounded-lg" maxlength="17"></div>
                                        <div class="md:col-span-2"><label for="bookPublicationDate" class="block text-gray-700 text-sm font-medium mb-2">Publication Date <span class="text-red-500">*</span></label><input type="date" id="bookPublicationDate" name="publicationDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                                    </div>
                                    <div class="flex justify-end mt-6 space-x-3">
                                        <button type="button" class="btn-secondary px-6 py-2 rounded-lg" onclick="document.getElementById('booksPanelAddBookForm').reset(); document.getElementById('addBookFormSectionInBooksPanel').classList.add('hidden'); document.getElementById('bookIdForEdit').value = '';">Cancel</button>
                                        <button type="submit" class="btn-primary px-6 py-2 rounded-lg">Save Book</button>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="mt-8 border-t pt-6">
                                <h3 class="text-lg font-semibold mb-4">Existing Books</h3>
                                <!-- Container for books list (table or cards) -->
                                <div id="books-list-container"> 
                                    <p class="py-4 text-center text-gray-500">Loading books...</p>
                                </div>
                            </div>
                        </div>
                    </div>   

                    <!-- Customers Panel -->
                    <div id="customers-panel" class="content-panel">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Manage Customers</h2>
                        <div class="card p-6">
                            <!-- MODIFIED BUTTONS -->
                            <button id="toggleAddCustomerFormBtn" class="btn-primary mb-6 px-6 py-2 rounded-lg">Add New Customer</button>
                            <button class="btn-secondary ml-2 mb-6 px-4 py-2 rounded-lg" onclick="showModifyCustomerForm()">Modify Customer</button>
                            <button class="btn-danger ml-2 mb-6 px-4 py-2 rounded-lg bg-red-500 text-white" onclick="showDeleteCustomerForm()">Remove Customer</button>
                            
                            <!-- ADDED Search UI -->
                            <div class="flex mb-4">
                                <select id="customers-search-criteria" class="px-4 py-2 border rounded-l-lg bg-white">
                                    <option value="name">Name</option>
                                    <option value="email">Email</option>
                                    <option value="id">Customer ID</option>
                                </select>
                                <input type="text" id="customers-search-query" placeholder="Search Customers..." class="flex-1 px-4 py-2 border-t border-b border-gray-300">
                                <button onclick="searchCustomers()" class="btn-primary px-4 py-2 rounded-r-lg">Search</button>
                            </div>

                            <div id="addCustomerFormSection" class="hidden mt-6 border-t pt-6">
                                <h3 class="text-lg font-semibold mb-4">Add/Edit Customer</h3>
                                <form id="addCustomerForm">
                                    <input type="hidden" id="customerIdForEdit" name="customerIdForEdit">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="custFirstName" class="block text-sm font-medium text-gray-700">First Name <span class="text-red-500">*</span></label><input type="text" name="firstName" id="custFirstName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div><label for="custLastName" class="block text-sm font-medium text-gray-700">Last Name <span class="text-red-500">*</span></label><input type="text" name="lastName" id="custLastName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div><label for="custEmail" class="block text-sm font-medium text-gray-700">Email <span class="text-red-500">*</span></label><input type="email" name="email" id="custEmail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div><label for="custPhone" class="block text-sm font-medium text-gray-700">Phone</label><input type="tel" name="phone" id="custPhone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div><label for="custPassword" class="block text-sm font-medium text-gray-700">Password (leave blank if no change)</label><input type="password" name="password" id="custPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div class="md:col-span-2"><label for="custShippingAddress" class="block text-sm font-medium text-gray-700">Shipping Address</label><textarea name="shippingAddress" id="custShippingAddress" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea></div><div class="md:col-span-2"><label for="custBillingAddress" class="block text-sm font-medium text-gray-700">Billing Address</label><textarea name="billingAddress" id="custBillingAddress" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea></div></div><div class="flex justify-end mt-6 space-x-3"><button type="button" class="btn-secondary px-6 py-2 rounded-lg" onclick="document.getElementById('addCustomerForm').reset(); document.getElementById('addCustomerFormSection').classList.add('hidden'); document.getElementById('customerIdForEdit').value='';">Cancel</button><button type="submit" class="btn-primary px-6 py-2 rounded-lg">Save Customer</button></div>
                                </form>
                            </div>
                            <div class="overflow-x-auto mt-4 border-t pt-6"><h3 class="text-lg font-semibold mb-4">Customer List</h3><table class="w-full"><thead><tr class="text-left text-gray-500 text-sm border-b"><th class="pb-3 px-2">ID</th><th class="pb-3 px-2">Name</th><th class="pb-3 px-2">Email</th><th class="pb-3 px-2">Total Orders</th><th class="pb-3 px-2">Actions</th></tr></thead><tbody id="customers-tbody"><tr><td colspan="5" class="py-4 text-center text-gray-500">Loading customers...</td></tr></tbody></table></div>
                        </div>
                    </div>
                    <!-- Orders Panel -->
                    <div id="orders-panel" class="content-panel">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Manage Orders</h2>
                        <div class="card p-6">
                            <!-- MODIFIED BUTTONS -->
                            <button id="toggleCreateOrderFormBtn" class="btn-primary mb-6 px-6 py-2 rounded-lg">Create New Order</button>
                            <button class="btn-secondary ml-2 mb-6 px-4 py-2 rounded-lg" onclick="showModifyOrderForm()">Modify Order Status</button>
                            <button class="btn-danger ml-2 mb-6 px-4 py-2 rounded-lg bg-red-500 text-white" onclick="showCancelOrderForm()">Cancel Order</button>
                            
                            <!-- ADDED Search UI -->
                            <div class="flex mb-4">
                                <select id="orders-search-criteria" class="px-4 py-2 border rounded-l-lg bg-white">
                                    <option value="id">Order ID</option>
                                    <option value="customerName">Customer Name</option>
                                    <option value="status">Status</option>
                                </select>
                                <input type="text" id="orders-search-query" placeholder="Search Orders..." class="flex-1 px-4 py-2 border-t border-b border-gray-300">
                                <button onclick="searchOrders()" class="btn-primary px-4 py-2 rounded-r-lg">Search</button>
                            </div>

                            <div id="createOrderFormSection" class="hidden mt-6 border-t pt-6"><h3 class="text-lg font-semibold mb-4">Create New Order</h3><form id="createOrderForm"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="orderCustomerId" class="block text-sm font-medium text-gray-700">Customer <span class="text-red-500">*</span></label><select name="customerId" id="orderCustomerId" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white"><option value="">Loading Customers...</option></select></div><div><label for="orderPaymentMethod" class="block text-sm font-medium text-gray-700">Payment Method <span class="text-red-500">*</span></label><select name="paymentMethod" id="orderPaymentMethod" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white"><option value="Cash">Cash</option><option value="Card">Card</option><option value="JazzCash">JazzCash</option><option value="EasyPaisa">EasyPaisa</option><option value="SadaPay">SadaPay</option></select></div></div><div class="mt-4"><h4 class="text-md font-semibold mb-2">Order Items</h4><div id="orderItemsContainer" class="space-y-2"></div><button type="button" id="addOrderItemBtn" class="mt-2 text-sm btn-secondary px-3 py-1 rounded-md">Add Item</button></div><div class="flex justify-end mt-6 space-x-3"><button type="button" class="btn-secondary px-6 py-2 rounded-lg" onclick="document.getElementById('createOrderForm').reset(); document.getElementById('orderItemsContainer').innerHTML=''; document.getElementById('createOrderFormSection').classList.add('hidden');">Cancel</button><button type="submit" class="btn-primary px-6 py-2 rounded-lg">Place Order</button></div></form></div>
                            <div class="overflow-x-auto mt-4 border-t pt-6"><h3 class="text-lg font-semibold mb-4">All Orders</h3><table class="w-full"><thead><tr class="text-left text-gray-500 text-sm border-b"><th class="pb-3 px-2">ID</th><th class="pb-3 px-2">Customer</th><th class="pb-3 px-2">Date</th><th class="pb-3 px-2">Amount</th><th class="pb-3 px-2">Status</th><th class="pb-3 px-2">Actions</th></tr></thead><tbody id="all-orders-tbody"><tr><td colspan="6" class="py-4 text-center text-gray-500">Loading all orders...</td></tr></tbody></table></div>
                            <div id="ordersPanelDetailsArea" class="mt-6 p-4 border rounded bg-gray-50 hidden">
                                <!-- Order details will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                    <!-- Genres Panel -->
                    <div id="genres-panel" class="content-panel">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Manage Genres</h2>
                        <div class="card p-6">
                            <button class="btn-primary mb-4 px-4 py-2 rounded-lg" onclick="showAddGenreForm()">Add New Genre</button>
                            <!-- Removed generic Modify/Delete for genres, as they are per-item in list -->
                             <!-- ADDED Search UI -->
                            <div class="flex mb-4">
                                <input type="text" id="genres-search-query" placeholder="Search Genres by Name..." class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg">
                                <button onclick="searchGenres()" class="btn-primary px-4 py-2 rounded-r-lg">Search</button>
                            </div>
                            
                            <div id="add-genre-form" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                                <h3 class="text-lg font-semibold mb-3">Add/Edit Genre</h3>
                                <form id="genreForm">
                                    <input type="hidden" id="genreIdInput"> <!-- Renamed from genreId to avoid conflict with var -->
                                    <div class="flex items-center">
                                        <input type="text" id="genreNameInput" required class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="Genre name">
                                        <button type="submit" class="btn-primary ml-2 px-4 py-2 rounded-lg">Save</button>
                                        <button type="button" class="btn-secondary ml-2 px-4 py-2 rounded-lg" onclick="cancelGenreEdit()">Cancel</button>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="mt-4 border-t pt-4">
                                <h3 class="text-lg font-semibold mb-3">Genre List</h3>
                                <ul id="genre-list-ul" class="divide-y divide-gray-200">
                                    <li class="py-2 text-gray-500">Loading genres...</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Authors Panel -->
                    <div id="authors-panel" class="content-panel">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Manage Authors</h2>
                        <div class="card p-6">
                            <!-- MODIFIED BUTTONS -->
                            <button id="toggleAddAuthorFormBtn" class="btn-primary mb-6 px-6 py-2 rounded-lg">Add New Author</button>
                            <button class="btn-secondary ml-2 mb-6 px-4 py-2 rounded-lg" onclick="showModifyAuthorForm()">Modify Author</button>
                            <button class="btn-danger ml-2 mb-6 px-4 py-2 rounded-lg bg-red-500 text-white" onclick="showDeleteAuthorForm()">Remove Author</button>

                             <!-- ADDED Search UI -->
                            <div class="flex mb-4">
                                <select id="authors-search-criteria" class="px-4 py-2 border rounded-l-lg bg-white">
                                    <option value="name">Name</option>
                                    <option value="id">Author ID</option>
                                </select>
                                <input type="text" id="authors-search-query" placeholder="Search Authors..." class="flex-1 px-4 py-2 border-t border-b border-gray-300">
                                <button onclick="searchAuthors()" class="btn-primary px-4 py-2 rounded-r-lg">Search</button>
                            </div>

                            <div id="addAuthorFormSection" class="hidden mt-6 border-t pt-6">
                                <h3 class="text-lg font-semibold mb-4">Add/Edit Author</h3>
                                <form id="addAuthorForm">
                                    <input type="hidden" id="authorIdForEdit" name="authorIdForEdit">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="authorName" class="block text-sm font-medium text-gray-700">Name <span class="text-red-500">*</span></label><input type="text" name="name" id="authorName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div><label for="authorDOB" class="block text-sm font-medium text-gray-700">Date of Birth</label><input type="date" name="dob" id="authorDOB" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div></div><div class="flex justify-end mt-6 space-x-3"><button type="button" class="btn-secondary px-6 py-2 rounded-lg" onclick="document.getElementById('addAuthorForm').reset(); document.getElementById('addAuthorFormSection').classList.add('hidden'); document.getElementById('authorIdForEdit').value='';">Cancel</button><button type="submit" class="btn-primary px-6 py-2 rounded-lg">Save Author</button></div>
                                </form>
                            </div>
                            <div class="overflow-x-auto mt-4 border-t pt-6"><h3 class="text-lg font-semibold mb-4">Author List</h3><table class="w-full"><thead><tr class="text-left text-gray-500 text-sm border-b"><th class="pb-3 px-2">ID</th><th class="pb-3 px-2">Name</th><th class="pb-3 px-2">DOB</th><th class="pb-3 px-2">Actions</th></tr></thead><tbody id="authors-tbody"><tr><td colspan="4" class="py-4 text-center text-gray-500">Loading authors...</td></tr></tbody></table></div>
                        </div>
                    </div>
                    <!-- Publishers Panel -->
                    <div id="publishers-panel" class="content-panel">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Manage Publishers</h2>
                        <div class="card p-6">
                            <!-- MODIFIED BUTTONS -->
                            <button id="toggleAddPublisherFormBtn" class="btn-primary mb-6 px-6 py-2 rounded-lg">Add New Publisher</button>
                            <button class="btn-secondary ml-2 mb-6 px-4 py-2 rounded-lg" onclick="showModifyPublisherForm()">Modify Publisher</button>
                            <button class="btn-danger ml-2 mb-6 px-4 py-2 rounded-lg bg-red-500 text-white" onclick="showDeletePublisherForm()">Remove Publisher</button>

                            <!-- ADDED Search UI -->
                            <div class="flex mb-4">
                                <select id="publishers-search-criteria" class="px-4 py-2 border rounded-l-lg bg-white">
                                    <option value="name">Name</option>
                                    <option value="id">Publisher ID</option>
                                    <option value="contact">Contact</option>
                                </select>
                                <input type="text" id="publishers-search-query" placeholder="Search Publishers..." class="flex-1 px-4 py-2 border-t border-b border-gray-300">
                                <button onclick="searchPublishers()" class="btn-primary px-4 py-2 rounded-r-lg">Search</button>
                            </div>
                            
                            <div id="addPublisherFormSection" class="hidden mt-6 border-t pt-6">
                                <h3 class="text-lg font-semibold mb-4">Add/Edit Publisher</h3>
                                <form id="addPublisherForm">
                                    <input type="hidden" id="publisherIdForEdit" name="publisherIdForEdit">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="publisherName" class="block text-sm font-medium text-gray-700">Name <span class="text-red-500">*</span></label><input type="text" name="name" id="publisherName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div><label for="publisherContact" class="block text-sm font-medium text-gray-700">Contact</label><input type="text" name="contact" id="publisherContact" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div class="md:col-span-2"><label for="publisherAddress" class="block text-sm font-medium text-gray-700">Address</label><textarea name="address" id="publisherAddress" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea></div></div><div class="flex justify-end mt-6 space-x-3"><button type="button" class="btn-secondary px-6 py-2 rounded-lg" onclick="document.getElementById('addPublisherForm').reset(); document.getElementById('addPublisherFormSection').classList.add('hidden'); document.getElementById('publisherIdForEdit').value='';">Cancel</button><button type="submit" class="btn-primary px-6 py-2 rounded-lg">Save Publisher</button></div>
                                </form>
                            </div>
                            <div class="overflow-x-auto mt-4 border-t pt-6"><h3 class="text-lg font-semibold mb-4">Publisher List</h3><table class="w-full"><thead><tr class="text-left text-gray-500 text-sm border-b"><th class="pb-3 px-2">ID</th><th class="pb-3 px-2">Name</th><th class="pb-3 px-2">Address</th><th class="pb-3 px-2">Contact</th><th class="pb-3 px-2">Actions</th></tr></thead><tbody id="publishers-tbody"><tr><td colspan="5" class="py-4 text-center text-gray-500">Loading publishers...</td></tr></tbody></table></div>
                        </div>
                    </div>
                    
                    <!-- Notifications Panel Page -->
                    <div id="notifications-panel-page" class="content-panel">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Notifications</h2>
                        <div class="card p-6">
                            <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                                <div class="flex-grow">
                                    <button id="filter-all-notifs" class="btn-secondary text-sm px-3 py-1 mr-2 rounded focus:outline-none focus:ring-2 focus:ring-gray-400">All</button>
                                    <button id="filter-unread-notifs" class="btn-secondary text-sm px-3 py-1 mr-2 rounded focus:outline-none focus:ring-2 focus:ring-gray-400">Unread</button>
                                    <button id="filter-read-notifs" class="btn-secondary text-sm px-3 py-1 rounded focus:outline-none focus:ring-2 focus:ring-gray-400">Read</button>
                                </div>
                                <button id="panel-mark-all-read-button" class="btn-primary text-sm px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-gray-500">Mark all as Read</button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div id="notifications-panel-content-area" class="md:col-span-1 h-[calc(100vh-300px)] overflow-y-auto border rounded-md p-2 space-y-2 bg-gray-50 custom-scrollbar">
                                    <!-- Notifications list will be rendered here by noti.js -->
                                    <p class="text-center text-gray-500 py-8">Loading notifications...</p>
                                </div>
                                <div id="notification-detail-view-area" class="md:col-span-2 hidden bg-white p-6 border rounded-md shadow min-h-[calc(100vh-300px)] custom-scrollbar overflow-y-auto">
                                    <!-- Notification detail will be rendered here by noti.js -->
                                    <p class="text-center text-gray-500">Select a notification to view details.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reports Panel -->
                    <div id="reports-panel" class="content-panel">
                        <!-- ... (Reports panel content - no changes) ... -->
                         <h2 class="text-2xl font-semibold text-gray-800 mb-6">Generated Reports</h2> 
                        <div id="analytics-content-wrapper" class="analytics-dashboard-styles">
                            <div class="dashboard">
                                <div class="header">
                                    <h1>Bookstore Analytics Dashboard</h1>
                                    <p>Real-time insights into your bookstore performance</p>
                                </div>
                                <button class="refresh-btn" onclick="analyticsLoadAllData()">Refresh Data</button>
                                <div class="kpi-section">
                                    <div class="kpi-card revenue">
                                        <div class="kpi-value" id="analyticsTotalRevenue">-</div>
                                        <div class="kpi-label">Total Revenue</div>
                                    </div>
                                    <div class="kpi-card books">
                                        <div class="kpi-value" id="analyticsTotalBooks">-</div>
                                        <div class="kpi-label">Total Books</div>
                                    </div>
                                    <div class="kpi-card orders">
                                        <div class="kpi-value" id="analyticsTotalOrders">-</div>
                                        <div class="kpi-label">Total Orders</div>
                                    </div>
                                    <div class="kpi-card customers">
                                        <div class="kpi-value" id="analyticsNewCustomers">-</div>
                                        <div class="kpi-label">Total Customers</div>
                                    </div>
                                </div>
                                <div class="charts-section">
                                    <div class="chart-container">
                                        <div class="chart-title">Top Selling Books</div>
                                        <canvas id="topBooksChart"></canvas>
                                    </div>
                                    <div class="chart-container">
                                        <div class="chart-title">Sales by Genre</div>
                                        <canvas id="genreChart"></canvas>
                                    </div>
                                    <div class="chart-container full-width">
                                        <div class="chart-title">Monthly Revenue Trend</div>
                                        <canvas id="revenueChart"></canvas>
                                    </div>
                                </div>
                                <div class="orders-section">
                                    <div class="chart-title">Recent Orders</div>
                                    <div id="analyticsOrdersContainer">
                                        <div class="loading">Loading orders...</div>
                                    </div>
                                </div>
                            </div> 
                            <div class="text-center py-10 text-gray-500" id="analytics-loading-message">Loading Analytics Dashboard...</div>
                        </div>
                    </div>
                    
                    <!-- Store Settings Panel -->
                    <div id="store-settings-panel" class="content-panel">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Store Settings</h2>
                        <div class="card p-6">
                            <p>Configure store settings.</p>
                            <form id="storeSettingsForm" class="mt-4 space-y-4">
                                <div>
                                    <label for="storeNameInput" class="block text-gray-700 text-sm font-medium mb-1">Store Name</label>
                                    <input type="text" id="storeNameInput" name="storeName" value="HHM Books" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="storeEmailInput" class="block text-gray-700 text-sm font-medium mb-1">Store Email</label>
                                    <input type="email" id="storeEmailInput" name="storeEmail" value="contact@hhmbooks.com" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <!-- You can add more settings fields here with unique IDs and names -->
                                <button type="submit" class="btn-primary px-6 py-2 rounded-lg">Save Settings</button>
                            </form>
                        </div>
                    </div>

                    <!-- Admin Users Panel -->
                    <div id="admin-users-panel" class="content-panel">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Manage Admin Users</h2>
                        <div class="card p-6">
                            <p>Manage administrator accounts.</p>
                            <!-- MODIFIED BUTTONS -->
                            <button class="btn-primary mt-4 px-6 py-2 rounded-lg" onclick="showAddAdminForm()">Add New Admin</button>
                            <button class="btn-secondary ml-2 mt-4 px-4 py-2 rounded-lg" onclick="showModifyAdminForm()">Modify Admin</button>
                            <button class="btn-danger ml-2 mt-4 px-4 py-2 rounded-lg bg-red-500 text-white" onclick="showDeleteAdminForm()">Remove Admin</button>
                            
                            <div class="overflow-x-auto mt-4">
                                <table class="w-full">
                                    <thead><tr class="text-left text-gray-500 text-sm border-b"><th class="pb-3">Username</th><th class="pb-3">Email</th><th class="pb-3">Role</th><th class="pb-3">Actions</th></tr></thead>
                                    <tbody><tr class="table-row border-b text-sm"><td class="py-4">sarahj</td><td class="py-4">sarah.johnson@example.com</td><td class="py-4">Super Admin</td><td class="py-4"><button class="text-blue-500 hover:text-blue-700">Edit</button> <button class="text-red-500 hover:text-red-700 ml-2">Delete</button></td></tr></tbody>
                                </table>
                            </div>
                            <!-- Add Admin Form (example, initially hidden) -->
                            <div id="addAdminFormSection" class="hidden mt-6 border-t pt-6">
                                <h3 class="text-lg font-semibold mb-4">Add/Edit Admin User</h3>
                                <form id="adminUserForm">
                                    <input type="hidden" id="adminIdForEdit">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div><label for="adminUsername" class="block text-sm font-medium text-gray-700">Username</label><input type="text" id="adminUsername" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
                                        <div><label for="adminEmail" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="adminEmail" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
                                        <div><label for="adminPassword" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="adminPassword" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
                                        <div><label for="adminRole" class="block text-sm font-medium text-gray-700">Role</label><input type="text" id="adminRole" value="Admin" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
                                    </div>
                                    <div class="flex justify-end mt-4">
                                        <button type="button" class="btn-secondary px-4 py-2 rounded-lg mr-2" onclick="document.getElementById('addAdminFormSection').classList.add('hidden'); document.getElementById('adminUserForm').reset();">Cancel</button>
                                        <button type="submit" class="btn-primary px-4 py-2 rounded-lg">Save Admin</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    
    <script src="notifications.js"></script> 

    <script>
        const LOW_STOCK_THRESHOLD = 10;
        let cachedAuthors = [];
        let cachedPublishers = [];
        let cachedCustomers = [];
        let cachedBooksInStock = [];
        let orderItemCounter = 0;

         let booksPanelViewMode = localStorage.getItem('booksPanelViewMode') || 'compact';
        let currentFetchedBooks = []; 

        const loginPageWrapper = document.getElementById('login-page-wrapper');
        const dashboardWrapper = document.getElementById('dashboard-wrapper');
        const loginForm = document.getElementById('loginForm');
        const logoutButton = document.getElementById('logout-button');
        
        function showDashboard() {
            loginPageWrapper.classList.add('hidden');
            dashboardWrapper.classList.remove('hidden');
            document.body.classList.add('lofi-bg');
            loadInitialDashboardData();
        }

        function showLoginPage() {
            dashboardWrapper.classList.add('hidden');
            loginPageWrapper.classList.remove('hidden');
            document.body.classList.add('lofi-bg');
            sessionStorage.removeItem('isLoggedIn');
            // Clear analytics interval if user logs out
            if (analyticsIntervalId) {
                clearInterval(analyticsIntervalId);
                analyticsIntervalId = null;
                console.log("Cleared analytics interval on logout.");
            }
        }

        // Removed the first (hardcoded) handleLogin function.
        // The second handleLogin function (using fetch API) at the end of the script is the one that will be used.

        function checkLoginState() {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                showDashboard();
            } else {
                showLoginPage();
            }
        }
        
        function loadInitialDashboardData() {
            updateKpis();
            displayRecentOrders();
            displayTopSellingBooks();
            checkAlerts();
            populateInitialDropdowns();
            
            if (typeof initializeNotificationSystem === 'function') {
                initializeNotificationSystem(); // ADD THIS LINE (from noti.js)
            }
        }
        
        const STORE_SETTINGS_KEY = 'hhmAdminStoreSettings';

        function loadStoreSettings() {
            const storeSettingsForm = document.getElementById('storeSettingsForm');
            if (!storeSettingsForm) return;

            const savedSettings = JSON.parse(localStorage.getItem(STORE_SETTINGS_KEY));

            if (savedSettings) {
                if (document.getElementById('storeNameInput')) {
                    document.getElementById('storeNameInput').value = savedSettings.storeName || 'HHM Books';
                }
                if (document.getElementById('storeEmailInput')) {
                    document.getElementById('storeEmailInput').value = savedSettings.storeEmail || 'contact@hhmbooks.com';
                }
                // Add more fields here if you have them
                // Example: document.getElementById('someOtherSetting').value = savedSettings.someOtherSetting || 'default';
                console.log('Store settings loaded from localStorage.');
            } else {
                // Set default values if nothing is in localStorage (though they are set by `value` in HTML)
                if (document.getElementById('storeNameInput')) {
                    document.getElementById('storeNameInput').value = 'HHM Books';
                }
                if (document.getElementById('storeEmailInput')) {
                    document.getElementById('storeEmailInput').value = 'contact@hhmbooks.com';
                }
                console.log('No store settings found in localStorage, using defaults.');
            }
        }

        function setBooksPanelViewMode(mode) {
            booksPanelViewMode = mode;
            localStorage.setItem('booksPanelViewMode', mode);
            
            const compactBtn = document.getElementById('books-view-compact-btn');
            const cozyBtn = document.getElementById('books-view-cozy-btn');

            if (compactBtn) compactBtn.classList.toggle('active-view-btn', mode === 'compact');
            if (cozyBtn) cozyBtn.classList.toggle('active-view-btn', mode === 'cozy');
            
            if (document.getElementById('books-panel')?.classList.contains('active')) {
                displayAllBooks(currentFetchedBooks, true); // Re-render with current books, forceRender = true
            }
        }

        
        function handleSaveStoreSettings(event) {
            event.preventDefault(); // IMPORTANT: Prevents page reload

            const storeName = document.getElementById('storeNameInput')?.value;
            const storeEmail = document.getElementById('storeEmailInput')?.value;

            if (!storeName || !storeEmail) {
                showToast('Store Name and Email cannot be empty.', 'error');
                return;
            }

            // Basic email validation (optional, but good practice)
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailPattern.test(storeEmail)) {
                showToast('Please enter a valid email address.', 'error');
                return;
            }

            const settingsToSave = {
                storeName: storeName,
                storeEmail: storeEmail,
                // Add more fields here:
                // someOtherSetting: document.getElementById('someOtherSetting').value,
            };

            try {
                localStorage.setItem(STORE_SETTINGS_KEY, JSON.stringify(settingsToSave));
                showToast('Store settings saved successfully!', 'success');
                console.log('Store settings saved to localStorage:', settingsToSave);

                // Optional: Update any displayed store name/email on the page if needed
                // For example, if the sidebar HHM Books title was dynamic:
                // const sidebarTitle = document.querySelector('.sidebar h1');
                // if (sidebarTitle) sidebarTitle.textContent = storeName;

            } catch (error) {
                console.error('Error saving settings to localStorage:', error);
                showToast('Failed to save settings. Storage might be full or unavailable.', 'error');
            }
        }

        
        let analyticsTopBooksChart, analyticsGenreChart, analyticsRevenueChart;
        let analyticsIntervalId = null;

        async function analyticsLoadAllData() {
            if (analyticsIntervalId && document.getElementById('reports-panel')?.classList.contains('active')) {
                 // Interval already running and panel is active, no need to clear and restart unless forced
            } else {
                if (analyticsIntervalId) clearInterval(analyticsIntervalId);
            }
            
            console.log("Loading analytics data...");
            const loadingMessage = document.getElementById('analytics-loading-message');
            if(loadingMessage) loadingMessage.style.display = 'block';

            try {
                const ordersContainer = document.getElementById('analyticsOrdersContainer');
                if(ordersContainer) ordersContainer.innerHTML = '<div class="loading">Loading orders...</div>';
                
                await Promise.all([
                    analyticsLoadKPIs(),
                    analyticsLoadTopSellingBooks(),
                    analyticsLoadRecentOrders(),
                    analyticsLoadGenreData(),
                    analyticsLoadRevenueData()
                ]);
                if (document.getElementById('reports-panel')?.classList.contains('active')) {
                   analyticsIntervalId = setInterval(analyticsLoadAllData, 300000); // 5 minutes
                }
            } catch (error) {
                console.error('Error loading analytics dashboard data:', error);
                analyticsShowError('Failed to load analytics dashboard data. Please check your API connection.');
            } finally {
                if(loadingMessage) loadingMessage.style.display = 'none';
            }
        }

        // ... (analyticsLoadKPIs, analyticsLoadTopSellingBooks, etc. - no changes) ...
        async function analyticsLoadKPIs() {
            try {
                const data = await fetchAPI('/api/kpis'); // Uses existing fetchAPI
                if (data) {
                    document.getElementById('analyticsTotalRevenue').textContent = `$${(data.totalRevenue || 0).toLocaleString()}`;
                    document.getElementById('analyticsTotalBooks').textContent = (data.totalBooks || 0).toLocaleString();
                    document.getElementById('analyticsTotalOrders').textContent = (data.totalOrders || 0).toLocaleString();
                    document.getElementById('analyticsNewCustomers').textContent = (data.newCustomers || 0).toLocaleString(); // Assuming newCustomers is total customers
                }
            } catch (error) {
                console.error('Error loading analytics KPIs:', error);
                document.getElementById('analyticsTotalRevenue').textContent = 'Error';
                // Set others to error too
            }
        }

        async function analyticsLoadTopSellingBooks() {
            try {
                const books = await fetchAPI('/api/top-selling-books'); // Uses existing fetchAPI
                if (!books) return;
                
                const topBooksChartCanvas = document.getElementById('topBooksChart');
                if(!topBooksChartCanvas) return;
                const ctx = topBooksChartCanvas.getContext('2d');
                
                if (analyticsTopBooksChart) {
                    analyticsTopBooksChart.destroy();
                }
                
                analyticsTopBooksChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: books.map(book => book.title.length > 20 ? book.title.substring(0, 20) + '...' : book.title),
                        datasets: [{
                            label: 'Books Sold',
                            data: books.map(book => book.sales || 0), // Ensure sales property exists
                            backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF'],
                            borderColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF'],
                            borderWidth: 2, borderRadius: 6, borderSkipped: false,
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#f0f0f0' } }, x: { grid: { display: false } } } }
                });
            } catch (error) {
                console.error('Error loading analytics top selling books:', error);
            }
        }

        async function analyticsLoadGenreData() {
            try {
                const books = await fetchAPI('/api/books'); // Uses existing fetchAPI
                if (!books) return;
                
                const genreCounts = {};
                books.forEach(book => {
                    const genre = book.Genre || 'Other';
                    genreCounts[genre] = (genreCounts[genre] || 0) + 1;
                });
                
                const genreChartCanvas = document.getElementById('genreChart');
                if(!genreChartCanvas) return;
                const ctx = genreChartCanvas.getContext('2d');
                
                if (analyticsGenreChart) {
                    analyticsGenreChart.destroy();
                }
                
                analyticsGenreChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(genreCounts),
                        datasets: [{
                            data: Object.values(genreCounts),
                            backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40','#C9CBCF'],
                            borderWidth: 2, borderColor: '#fff'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } } } }
                });
            } catch (error) {
                console.error('Error loading analytics genre data:', error);
            }
        }

        async function analyticsLoadRevenueData() {
            try {
                const monthlyRevenue = {};
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                months.forEach((month) => {
                    monthlyRevenue[month] = Math.floor(Math.random() * 15000) + 5000;
                });

                const revenueChartCanvas = document.getElementById('revenueChart');
                if (!revenueChartCanvas) return;
                const ctx = revenueChartCanvas.getContext('2d');
                
                if (analyticsRevenueChart) {
                    analyticsRevenueChart.destroy();
                }
                
                analyticsRevenueChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Object.keys(monthlyRevenue),
                        datasets: [{
                            label: 'Monthly Revenue ($)',
                            data: Object.values(monthlyRevenue),
                            borderColor: '#36A2EB', backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 3, fill: true, tension: 0.4,
                            pointBackgroundColor: '#36A2EB', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 6, pointHoverRadius: 8
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#f0f0f0' }, ticks: { callback: function(value) { return '$' + value.toLocaleString(); } } }, x: { grid: { display: false } } } }
                });
            } catch (error) {
                console.error('Error loading analytics revenue data:', error);
            }
        }

        async function analyticsLoadRecentOrders() {
            try {
                const orders = await fetchAPI('/api/recent-orders');
                const container = document.getElementById('analyticsOrdersContainer');
                if(!container) return;

                if (!orders || orders.length === 0) {
                    container.innerHTML = '<div class="loading">No recent orders found.</div>';
                    return;
                }
                
                const tableHTML = `
                    <table class="orders-table">
                        <thead><tr><th>Order ID</th><th>Customer</th><th>Date</th><th>Amount</th><th>Status</th></tr></thead>
                        <tbody>
                            ${orders.map(order => `
                                <tr>
                                    <td>#${order.OrderID}</td>
                                    <td>${order.CustomerName || 'N/A'}</td>
                                    <td>${new Date(order.OrderDate).toLocaleDateString()}</td>
                                    <td>$${(order.amount || 0).toFixed(2)}</td>
                                    <td><span class="status-badge status-${(order.Status || 'unknown').toLowerCase().replace(/\s+/g, '-')}">${order.Status || 'N/A'}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`;
                container.innerHTML = tableHTML;
            } catch (error) {
                console.error('Error loading analytics recent orders:', error);
                const container = document.getElementById('analyticsOrdersContainer');
                if(container) container.innerHTML = '<div class="error">Failed to load recent orders</div>';
            }
        }
        function analyticsShowError(message) { showToast(message, 'error', 5000); }
        
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginState(); 

            if(loginForm) {
                loginForm.addEventListener('submit', handleLogin); // Uses the API-based handleLogin
            }
            
            if(logoutButton) {
                logoutButton.addEventListener('click', () => {
                    showLoginPage();
                    showToast('Logged out successfully.', 'info');
                });
            }

            const mainNavLinks = document.querySelectorAll('.main-nav .nav-link, .mobile-nav .mobile-nav-link');
            const contentPanels = document.querySelectorAll('.content-panel');
            const mainContentTitle = document.getElementById('main-content-title');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const sidebar = document.querySelector('.sidebar');

            document.getElementById('books-view-compact-btn')?.addEventListener('click', () => setBooksPanelViewMode('compact'));
            document.getElementById('books-view-cozy-btn')?.addEventListener('click', () => setBooksPanelViewMode('cozy'));
            const notificationPopup = document.getElementById('notification-popup');            
            
            window.setActivePanel = function(targetId, linkTextFromNav) { 
                let panelTitle = linkTextFromNav;
                if (!panelTitle) { 
                    const activeNavLink = document.querySelector(`.nav-link[data-target="${targetId}"]`);
                    panelTitle = activeNavLink ? activeNavLink.textContent.trim() : targetId.replace('-panel', '').split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                }
                if(mainContentTitle) mainContentTitle.textContent = panelTitle;

                contentPanels.forEach(panel => panel.classList.remove('active'));
                const targetPanel = document.getElementById(targetId);
                if (targetPanel) targetPanel.classList.add('active');

                if (targetId === 'reports-panel') {
                    if (typeof analyticsLoadAllData === 'function') {
                        analyticsLoadAllData(); // Load data and potentially start interval
                    }
                } else {
                    if (analyticsIntervalId) {
                        clearInterval(analyticsIntervalId);
                        analyticsIntervalId = null;
                        console.log("Cleared analytics interval.");
                    }
                }

                mainNavLinks.forEach(link => {
                    link.classList.remove('active', 'text-white');
                    link.classList.add('text-gray-300'); 
                    if (link.closest('.mobile-nav')) { 
                         link.classList.remove('bg-gray-700', 'text-white');
                         link.classList.add('text-gray-400');
                    }
                    if (link.dataset.target === targetId) {
                        link.classList.add('active', 'text-white');
                        link.classList.remove('text-gray-300');
                         if (link.closest('.mobile-nav')) {
                            link.classList.add('bg-gray-700', 'text-white');
                            link.classList.remove('text-gray-400');
                        }
                    }
                });

                if (sidebar && !sidebar.classList.contains('hidden') && window.innerWidth < 768) {
                    sidebar.classList.add('hidden');
                    sidebar.classList.remove('block');
                }
                
                 if (targetId === 'books-panel') {
                    displayAllBooks(); 
                    setBooksPanelViewMode(booksPanelViewMode);
                }
                if (targetId === 'customers-panel') displayAllCustomers();
                if (targetId === 'orders-panel') displayAllOrders();
                if (targetId === 'genres-panel') displayGenres();
                if (targetId === 'authors-panel') displayAuthorsList();
                if (targetId === 'publishers-panel') displayPublishersList();
                if (targetId === 'notifications-panel-page') { // ADD THIS
                if (typeof renderNotificationsPanel === 'function') {
                        renderNotificationsPanel(); // Ensure panel renders with current data when switched to
                    }
            }
            }

            function handleNavLinkClick(event) {
                event.preventDefault();
                const targetId = this.dataset.target;
                const linkText = this.textContent.trim(); // Or find a more reliable way to get title
                setActivePanel(targetId, linkText);
            }
            mainNavLinks.forEach(link => link.addEventListener('click', handleNavLinkClick));

            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', function() {
                    if(sidebar) { sidebar.classList.toggle('hidden'); sidebar.classList.toggle('block'); }
                });
            }
            
            const refreshDataButton = document.getElementById('refresh-data-button');
            if (refreshDataButton) {
                refreshDataButton.addEventListener('click', async function() {
                    showToast('Refreshing data...', 'info', 1500);
                    this.disabled = true; 
                    this.querySelector('i').classList.add('fa-spin'); 
                    try {
                        await Promise.all([ updateKpis(), displayRecentOrders(), displayTopSellingBooks(), checkAlerts() ]);
                        
                        if (typeof loadNotificationsFromServer === 'function') {
                            await loadNotificationsFromServer();
                        }

                        const activePanel = document.querySelector('.content-panel.active');
                        if (activePanel) {
                            const activePanelId = activePanel.id;
                            if (activePanelId === 'reports-panel' && typeof analyticsLoadAllData === 'function') {
                                await analyticsLoadAllData(); // Refresh analytics data
                            } else {
                                // Refresh data for other panels if they are active
                                switch (activePanelId) {
                                    case 'books-panel': await displayAllBooks(); break;
                                    case 'customers-panel': await displayAllCustomers(); break;
                                    case 'orders-panel': await displayAllOrders(); break;
                                    case 'genres-panel': await displayGenres(); break;
                                    case 'authors-panel': await displayAuthorsList(); break;
                                    case 'publishers-panel': await displayPublishersList(); break;
                                }
                            }
                        }
                        showToast('Data refreshed successfully!', 'success');
                    } catch (error) {
                        console.error("Error during manual refresh:", error);
                        showToast('Failed to refresh some data. Check console.', 'error');
                    } finally {
                        this.disabled = false; 
                        this.querySelector('i').classList.remove('fa-spin'); 
                    }
                });
            }

            notificationBellButton?.addEventListener('click', (e) => { e.stopPropagation(); notificationPopup.classList.toggle('hidden'); if (!notificationPopup.classList.contains('hidden') && typeof initializeNotificationSystem === 'function' && typeof renderNotifications === 'function') { /* We already call initializeNotificationSystem globally, ensure renderNotifications is called if needed here */ renderNotifications(); }});
            markAllReadButton?.addEventListener('click', () => { if(typeof markAllNotificationsAsRead === 'function') markAllNotificationsAsRead(); });
            notificationList?.addEventListener('click', (e) => { if (e.target.classList.contains('mark-as-read-btn') && typeof markNotificationAsRead === 'function') markNotificationAsRead(e.target.closest('.notification-item').dataset.notificationId); });
            document.addEventListener('click', (e) => { if (notificationPopup && !notificationPopup.classList.contains('hidden') && !notificationPopup.contains(e.target) && e.target !== notificationBellButton && !notificationBellButton.contains(e.target) ) notificationPopup.classList.add('hidden'); });
            
             const viewAllNotificationsLink = document.getElementById('view-all-notifications-link');
            if (viewAllNotificationsLink) {
                viewAllNotificationsLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (typeof setActivePanel === 'function') {
                        setActivePanel('notifications-panel-page', 'All Notifications');
                        // Close the dropdown popup
                        const notifPopup = document.getElementById('notification-popup');
                        if (notifPopup) notifPopup.classList.add('hidden');
                    }
                });
            }

            setupFormHandlers();
            
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                if(document.getElementById('dashboard-wrapper') && !document.getElementById('dashboard-wrapper').classList.contains('hidden')){
                    loadInitialDashboardData();

                    const activePanel = document.querySelector('.content-panel.active');
                    if (activePanel && activePanel.id === 'books-panel') {
                        setBooksPanelViewMode(booksPanelViewMode);
                    }
                }
            }
        });

        function setupFormHandlers() {
            document.getElementById('booksPanelAddBookForm')?.addEventListener('submit', handleAddOrUpdateBook); // Modified
            document.getElementById('toggleAddCustomerFormBtn')?.addEventListener('click', () => {
                document.getElementById('addCustomerFormSection').classList.toggle('hidden');
                document.getElementById('addCustomerForm').reset();
                document.getElementById('customerIdForEdit').value = ''; // Clear edit ID
            });
            document.getElementById('addCustomerForm')?.addEventListener('submit', handleAddOrUpdateCustomer);
            document.getElementById('toggleAddAuthorFormBtn')?.addEventListener('click', () => {
                document.getElementById('addAuthorFormSection').classList.toggle('hidden');
                document.getElementById('addAuthorForm').reset();
                document.getElementById('authorIdForEdit').value = '';
            });
            document.getElementById('addAuthorForm')?.addEventListener('submit', handleAddOrUpdateAuthor);
            document.getElementById('toggleAddPublisherFormBtn')?.addEventListener('click', () => {
                document.getElementById('addPublisherFormSection').classList.toggle('hidden');
                document.getElementById('addPublisherForm').reset();
                document.getElementById('publisherIdForEdit').value = '';
            });
            document.getElementById('addPublisherForm')?.addEventListener('submit', handleAddOrUpdatePublisher);
            document.getElementById('toggleCreateOrderFormBtn')?.addEventListener('click', () => {
                const formSection = document.getElementById('createOrderFormSection');
                formSection.classList.toggle('hidden');
                if (!formSection.classList.contains('hidden')) {
                    populateOrderFormDropdowns();
                    document.getElementById('orderItemsContainer').innerHTML = '';
                    addOrderItemRow(); 
                }
            });
            document.getElementById('createOrderForm')?.addEventListener('submit', handleCreateOrder);
            document.getElementById('addOrderItemBtn')?.addEventListener('click', addOrderItemRow);
            document.getElementById('quickAddBookForm')?.addEventListener('submit', (e) => { e.preventDefault(); showToast('Quick Add Book is a demo. Use Books panel.', 'info');});
            document.getElementById('genreForm')?.addEventListener('submit', handleGenreFormSubmit); // For genres
            document.getElementById('adminUserForm')?.addEventListener('submit', handleAdminUserFormSubmit);
        }

        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            if(!container) return;
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => { if(container.contains(toast)) container.removeChild(toast); }, 300);
            }, duration);
        }
        async function fetchAPI(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    let errorData;
                    try { errorData = await response.json(); } 
                    catch (e) { errorData = { error: `HTTP error! Status: ${response.status}` }; }
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }
                if (response.status === 204 || response.headers.get("content-length") === "0") return null; // Handle 204 No Content
                return await response.json();
            } catch (error) { console.error(`API Error (${options.method || 'GET'} ${url}):`, error); showToast(`Error: ${error.message}`, 'error'); throw error; }
        }
        async function populateInitialDropdowns() { await Promise.all([ fetchAuthors(true), fetchPublishers(true), fetchCustomersForDropdown(true), fetchBooksForDropdown(true) ]); }
        async function updateKpis() { try { const data = await fetchAPI('/api/kpis'); if(document.getElementById('total-books-value')) document.getElementById('total-books-value').textContent = data.totalBooks || 0; if(document.getElementById('total-orders-value')) document.getElementById('total-orders-value').textContent = data.totalOrders || 0; if(document.getElementById('total-revenue-value')) document.getElementById('total-revenue-value').textContent = `$${Number(data.totalRevenue || 0).toFixed(2)}`; if(document.getElementById('new-customers-value')) document.getElementById('new-customers-value').textContent = data.newCustomers || 0; } catch (error) {/* Already handled by fetchAPI */} }
        async function displayRecentOrders() { const tbody = document.getElementById('recent-orders-tbody'); if(!tbody) return; tbody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-gray-500">Loading...</td></tr>`; try { const orders = await fetchAPI('/api/recent-orders'); if (!orders || orders.length === 0) { tbody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-gray-500">No recent orders.</td></tr>`; return; } tbody.innerHTML = orders.map(order => { const orderDate = order.OrderDate ? new Date(order.OrderDate).toLocaleDateString() : 'N/A'; return ` <tr class="table-row border-b text-sm"> <td class="py-3 px-2">${order.OrderID}</td> <td class="py-3 px-2">${order.CustomerName || 'N/A'}</td> <td class="py-3 px-2">${orderDate}</td> <td class="py-3 px-2">$${Number(order.amount || 0).toFixed(2)}</td> <td class="py-3 px-2"><span class="px-2 py-1 rounded-full text-xs ${getOrderStatusClass(order.Status)}">${order.Status || 'N/A'}</span></td> <td class="py-3 px-2"><button class="text-blue-500 hover:text-blue-700 text-xs" onclick="viewOrderDetails(${order.OrderID})">Details</button></td> </tr>`}).join(''); } catch (error) { tbody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-red-500">Error loading orders.</td></tr>`; } }
        async function displayTopSellingBooks() {
            const container = document.getElementById('top-selling-books-container');
            if (!container) return;
            container.innerHTML = `<p class="text-center text-gray-500">Loading...</p>`;
            try {
                const books = await fetchAPI('/api/top-selling-books'); // This API should now return 'bookCover'
                if (!books || books.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500">No top sellers found.</p>`;
                    return;
                }
                container.innerHTML = books.map(book => `
                    <div class="flex items-center mb-3">
                        <div class="flex-shrink-0">
                            <img src="${book.bookCover || 'https://via.placeholder.com/48x64.png?text=N/A'}" alt="${book.title}" class="w-12 h-16 object-cover rounded shadow-md">
                        </div>
                        <div class="ml-4 overflow-hidden">
                            <h4 class="font-medium text-sm truncate" title="${book.title}">${book.title}</h4>
                            <p class="text-xs text-gray-500 truncate" title="${book.author}">${book.author}</p>
                        </div>
                        <div class="ml-auto text-right flex-shrink-0 pl-2">
                            <p class="font-medium text-sm">$${Number(book.price).toFixed(2)}</p>
                            <p class="text-xs text-green-500">+${book.sales || 0} sales</p>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error displaying top selling books:', error); // Added console.error for better debugging
                container.innerHTML = `<p class="text-center text-red-500">Error loading top sellers.</p>`;
            }
        }
        async function checkAlerts() { const alertBox = document.getElementById('inventory-alert-box'); const alertMsg = document.getElementById('inventory-alert-message'); if(!alertBox || !alertMsg) return; try { const lowStockBooks = await fetchAPI(`/api/low-stock-books/${LOW_STOCK_THRESHOLD}`); if (lowStockBooks && lowStockBooks.length > 0) { alertMsg.textContent = `${lowStockBooks.length} book(s) are running low (less than ${LOW_STOCK_THRESHOLD} items).`; alertBox.classList.remove('hidden'); } else { alertBox.classList.add('hidden'); } } catch (error) { alertBox.classList.add('hidden'); } }
        
        // --- Book Management ---
        function showAddBookForm() {
            document.getElementById('addBookFormSectionInBooksPanel').classList.remove('hidden');
            populateAuthorPublisherDropdownsForBooksPanel();
            document.getElementById('booksPanelAddBookForm').reset();
            document.getElementById('bookIdForEdit').value = ''; // Ensure it's add mode
            document.querySelector('#addBookFormSectionInBooksPanel h3').textContent = 'Add a New Book';
        }
        async function showModifyBookForm() {
            const bookIdToModify = prompt("Enter BookID to modify:");
            if (bookIdToModify && !isNaN(bookIdToModify)) {
                try {
                    const book = await fetchAPI(`/api/books/${bookIdToModify}`); 
                    if (book) {
                        document.getElementById('addBookFormSectionInBooksPanel').classList.remove('hidden');
                        populateAuthorPublisherDropdownsForBooksPanel().then(() => { 
                            document.getElementById('bookIdForEdit').value = book.BookID;
                            document.getElementById('bookTitle').value = book.Title;
                            document.getElementById('bookAuthor').value = book.AuthorID;
                            document.getElementById('bookPublisher').value = book.PublisherID;
                            document.getElementById('bookGenre').value = book.Genre || '';
                            document.getElementById('bookPrice').value = book.Price;
                            document.getElementById('bookStock').value = book.Stock;
                            document.getElementById('bookFormat').value = book.Format;
                            document.getElementById('bookLanguage').value = book.Language || '';
                            document.getElementById('bookPublicationDate').value = book.PublicationDate ? new Date(book.PublicationDate).toISOString().split('T')[0] : '';
                            document.getElementById('bookISBN').value = book.ISBN || ''; // Populate ISBN
                            document.getElementById('bookCoverURL').value = book.BookCover || ''; // Populate BookCover
                        });
                        document.querySelector('#addBookFormSectionInBooksPanel h3').textContent = 'Edit Book';
                    }
                } catch (error) { /* fetchAPI shows toast */ }
            } else if (bookIdToModify) { // if value entered but not a number or cancelled
                showToast('Invalid Book ID.', 'error');
            }
        }

         async function showDeleteBookForm() {
            const bookIdToDelete = prompt("Enter BookID to delete:");
            if (bookIdToDelete && !isNaN(bookIdToDelete)) {
                // Fetch book details to include in notification BEFORE deleting
                let bookTitle = `Book ID ${bookIdToDelete}`; // Fallback title
                try {
                    const book = await fetchAPI(`/api/books/${bookIdToDelete}`);
                    if (book && book.Title) bookTitle = book.Title;
                } catch (fetchError) {
                    console.warn("Could not fetch book details for delete notification:", fetchError);
                }

                if (confirm(`Are you sure you want to delete ${bookTitle}? This action cannot be undone.`)) {
                    try {
                        await fetchAPI(`/api/books/${bookIdToDelete}`, { method: 'DELETE' });
                        showToast('Book deleted successfully!', 'success');
                        if (typeof createNewNotification === 'function') {
                            createNewNotification(
                                `Book Deleted: ${bookTitle.substring(0,30)}...`,
                                `The book "${bookTitle}" has been deleted.`,
                                'info',
                                '#books-panel'
                            );
                        }
                        displayAllBooks();
                        updateKpis();
                    } catch (error) { /* fetchAPI shows toast */ }
                }
            } else if (bookIdToDelete) {
                showToast('Invalid Book ID.', 'error');
            }
        }

        async function populateAuthorPublisherDropdownsForBooksPanel() { 
            const authorSelect = document.getElementById('bookAuthor'); 
            const publisherSelect = document.getElementById('bookPublisher'); 
            if(!authorSelect || !publisherSelect) return; 
            authorSelect.innerHTML = '<option value="">Loading Authors...</option>'; 
            publisherSelect.innerHTML = '<option value="">Loading Publishers...</option>'; 
            try { 
                const authors = await fetchAuthors(); 
                authorSelect.innerHTML = '<option value="">Select an Author</option>'; 
                authors.forEach(author => authorSelect.add(new Option(author.Name, author.AuthorID))); 
                const publishers = await fetchPublishers(); 
                publisherSelect.innerHTML = '<option value="">Select a Publisher</option>'; 
                publishers.forEach(publisher => publisherSelect.add(new Option(publisher.Name, publisher.PublisherID))); 
            } catch (error) { 
                authorSelect.innerHTML = '<option value="">Error loading authors</option>'; 
                publisherSelect.innerHTML = '<option value="">Error loading publishers</option>'; 
            } 
        }
         async function handleAddOrUpdateBook(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const bookData = Object.fromEntries(formData.entries());
            const bookId = bookData.bookIdForEdit; 
            bookData.authorId = parseInt(bookData.authorId);
            bookData.publisherId = parseInt(bookData.publisherId);
            bookData.price = parseFloat(bookData.price);
            bookData.stock = parseInt(bookData.stock);

            if (!bookData.title || !bookData.authorId || !bookData.publisherId || bookData.price == null || bookData.stock == null || !bookData.format || !bookData.publicationDate) {
                showToast('Please fill in all required fields (*).', 'error'); return;
            }
            if (bookData.price < 0 || bookData.stock < 0) {
                showToast('Price and Stock cannot be negative.', 'error'); return;
            }

            const url = bookId ? `/api/books/${bookId}` : '/api/books';
            const method = bookId ? 'PUT' : 'POST';

            try {
                await fetchAPI(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(bookData) });
                const action = bookId ? 'updated' : 'added';
                showToast(`Book ${action} successfully!`, 'success');

                if (typeof createNewNotification === 'function') {
                    const bookTitleSummary = bookData.title.length > 30 ? bookData.title.substring(0, 27) + '...' : bookData.title;
                    createNewNotification(
                        `Book ${action}: ${bookTitleSummary}`,
                        `The book "${bookData.title}" has been successfully ${action}. Stock: ${bookData.stock}, Price: $${bookData.price.toFixed(2)}.`,
                        'success',
                        '#books-panel'
                    );
                }
                e.target.reset();
                document.getElementById('addBookFormSectionInBooksPanel').classList.add('hidden');
                document.getElementById('bookIdForEdit').value = ''; 
                displayAllBooks();
                updateKpis();
            } catch (error) { /* Handled by fetchAPI */ }
        }
        
       async function displayAllBooks(booksToDisplay = null, forceRender = false) {
            const container = document.getElementById('books-list-container');
            if (!container) return;

            if (!forceRender && booksToDisplay && booksToDisplay.length > 0 && currentFetchedBooks === booksToDisplay) {
                 // If booksToDisplay is the same as currentFetchedBooks and not forcing render, assume it's already rendered correctly for the view mode.
                 // This check is a bit simple; might need refinement if search results are passed frequently.
                 // The main idea is to avoid re-rendering if only view mode changed and books are the same.
                 // However, setBooksPanelViewMode calls this with forceRender = true.
            } else {
                 container.innerHTML = `<p class="py-4 text-center text-gray-500">Loading books...</p>`;
            }
            
            try {
                let books;
                if (booksToDisplay && forceRender) { // If books are passed and we must re-render (e.g. view mode change)
                    books = booksToDisplay;
                } else if (booksToDisplay) { // If books are passed (e.g. search results)
                    books = booksToDisplay;
                    currentFetchedBooks = books; // Cache search results
                } else { // Default: fetch all books
                    books = await fetchAPI('/api/books');
                    currentFetchedBooks = books; // Cache all books
                }


                if (!books || books.length === 0) {
                    container.innerHTML = `<p class="py-4 text-center text-gray-500">${(booksToDisplay || currentFetchedBooks !== books) ? 'No books found matching search.' : 'No books found.'}</p>`;
                    return;
                }

                if (booksPanelViewMode === 'compact') {
                    let tableHTML = `<div class="overflow-x-auto"><table class="w-full"><thead><tr class="text-left text-gray-500 text-sm border-b">
                        <th class="pb-3 px-2">ID</th>
                        <th class="pb-3 px-2">Title</th>
                        <th class="pb-3 px-2">Author</th>
                        <th class="pb-3 px-2">ISBN</th>
                        <th class="pb-3 px-2">Price</th>
                        <th class="pb-3 px-2">Stock</th>
                        <th class="pb-3 px-2">Format</th>
                        <th class="pb-3 px-2">Actions</th>
                        </tr></thead><tbody>`;
                    tableHTML += books.map(book => `
                        <tr class="table-row border-b text-sm">
                            <td class="py-3 px-2">${book.BookID}</td>
                            <td class="py-3 px-2 truncate" title="${book.Title}">${book.Title}</td>
                            <td class="py-3 px-2 truncate" title="${book.AuthorName}">${book.AuthorName || 'N/A'}</td>
                            <td class="py-3 px-2">${book.ISBN || 'N/A'}</td>
                            <td class="py-3 px-2">$${Number(book.Price).toFixed(2)}</td>
                            <td class="py-3 px-2"> <span class="px-2 py-1 rounded-full text-xs ${getStockStatusClass(book.Stock)}">${book.Stock}</span> </td>
                            <td class="py-3 px-2">${book.Format}</td>
                            <td class="py-3 px-2 whitespace-nowrap">
                                <button class="text-blue-600 hover:text-blue-800 mr-1 p-1 text-xs" title="Edit Book" onclick="openEditBookModal(${book.BookID})"><i class="fas fa-edit"></i></button>
                                <button class="text-red-600 hover:text-red-800 mr-1 p-1 text-xs" title="Delete Book" onclick="confirmDeleteBook(${book.BookID})"><i class="fas fa-trash"></i></button>
                                <button class="text-green-500 hover:text-green-700 mr-1 p-1 text-xs" title="Increase stock by 1" onclick="updateBookStock(${book.BookID}, 1, this)"><i class="fas fa-plus-circle"></i></button>
                                <button class="text-red-500 hover:text-red-700 mr-1 p-1 text-xs" title="Decrease stock by 1" onclick="updateBookStock(${book.BookID}, -1, this)"><i class="fas fa-minus-circle"></i></button>
                                <input type="number" class="w-12 p-1 border rounded text-xs stock-change-input-${book.BookID}" placeholder="Qty">
                                <button class="text-blue-500 hover:text-blue-700 p-1 text-xs" onclick="updateBookStockByInput(${book.BookID}, this)">Set</button>
                            </td>
                        </tr>`).join('');
                    tableHTML += `</tbody></table></div>`;
                    container.innerHTML = tableHTML;
                } else { // Cozy mode
                    let cardsHTML = `<div class="space-y-4">`;
                    cardsHTML += books.map(book => `
                        <div class="card p-4 flex flex-row w-full gap-6">
                            <div class="flex-shrink-0 flex justify-center md:justify-start">
                                <img src="${book.BookCover || 'https://via.placeholder.com/180x272.png?text=No+Cover'}" alt="${book.Title}" width='180px' height='272px' class="w-[180px] h-[272px] object-cover rounded-md shadow-lg book-cover-cozy">
                            </div>
                            <div class="flex-col">
                                <h4 class="text-3xl font-semibold text-gray-800 mb-4">${book.Title}</h4>
                                <p class="text-lg text-gray-600 mb-2">by ${book.AuthorName || 'Unknown Author'}</p>
                                <p class="text-lg text-gray-500 mb-2">ISBN: ${book.ISBN || 'N/A'}</p>
                                <div class="text-lg text-gray-700 mb-4">
                                    <span class="font-medium">Price:</span> $${Number(book.Price).toFixed(2)} | 
                                    <span class="font-medium">Stock:</span> <span class="px-1 py-0.5 rounded text-base ${getStockStatusClass(book.Stock)}">${book.Stock}</span> | 
                                    <span class="font-medium">Format:</span> ${book.Format}
                                </div>
                                <div class="text-base text-gray-500 mb-6">
                                    <p><span class="font-medium">Publisher:</span> ${book.PublisherName || 'N/A'}</p>
                                    <p><span class="font-medium">Language:</span> ${book.Language || 'N/A'} | <span class="font-medium">Published:</span> ${book.PublicationDate ? new Date(book.PublicationDate).toLocaleDateString() : 'N/A'}</p>
                                    <p><span class="font-medium">Genre:</span> ${book.Genre || 'N/A'}</p>
                                </div>
                                <div class="mt-auto flex items-center space-x-2">
                                    <button class="btn-secondary px-3 py-1 text-xs rounded-md" onclick="openEditBookModal(${book.BookID})"><i class="fas fa-edit mr-1"></i>Edit</button>
                                    <button class="btn-danger bg-red-500 text-white px-3 py-1 text-xs rounded-md" onclick="confirmDeleteBook(${book.BookID})"><i class="fas fa-trash mr-1"></i>Delete</button>
                                    <!-- You might want to simplify stock controls for cozy view or keep them -->
                                </div>
                            </div>
                        </div>
                    `).join('');
                    cardsHTML += `</div>`;
                    container.innerHTML = cardsHTML;
                }
            } catch (error) {
                console.error("Error in displayAllBooks:", error);
                container.innerHTML = `<p class="py-4 text-center text-red-500">Error loading books.</p>`;
            }
        }

        async function openEditBookModal(bookId) { // For row edit button
            try {
                const book = await fetchAPI(`/api/books/${bookId}`);
                if (book) {
                    showAddBookForm(); // Re-use the form by clearing and showing it
                    document.querySelector('#addBookFormSectionInBooksPanel h3').textContent = 'Edit Book';
                    populateAuthorPublisherDropdownsForBooksPanel().then(() => {
                        document.getElementById('bookIdForEdit').value = book.BookID;
                        document.getElementById('bookTitle').value = book.Title;
                        document.getElementById('bookAuthor').value = book.AuthorID; // Make sure this is ID
                        document.getElementById('bookPublisher').value = book.PublisherID; // Make sure this is ID
                        document.getElementById('bookGenre').value = book.Genre || '';
                        document.getElementById('bookPrice').value = book.Price;
                        document.getElementById('bookStock').value = book.Stock;
                        document.getElementById('bookFormat').value = book.Format;
                        document.getElementById('bookLanguage').value = book.Language || '';
                        document.getElementById('bookPublicationDate').value = book.PublicationDate ? new Date(book.PublicationDate).toISOString().split('T')[0] : '';
                        document.getElementById('bookISBN').value = book.ISBN || ''; // Populate ISBN
                        document.getElementById('bookCoverURL').value = book.BookCover || ''; // Populate BookCover
                    });
                }
            } catch (error) { /* Handled by fetchAPI */ }
        }
        async function confirmDeleteBook(bookId) { // For row delete button
             if (confirm(`Are you sure you want to delete Book ID ${bookId}?`)) {
                try {
                    await fetchAPI(`/api/books/${bookId}`, { method: 'DELETE' });
                    showToast('Book deleted successfully!', 'success');
                    displayAllBooks(); // Refresh list
                } catch (error) { /* Handled by fetchAPI */ }
            }
        }
        async function searchBooks() {
            const criteria = document.getElementById('books-search-criteria').value;
            const query = document.getElementById('books-search-query').value.trim();
            if (!query && criteria !== 'all') { // 'all' criteria could mean show all books
                showToast('Please enter a search term or select "All" if available.', 'info');
                displayAllBooks(); // Default to showing all if query is empty
                return;
            }
            try {
                const books = await fetchAPI(`/api/books/search?criteria=${encodeURIComponent(criteria)}&query=${encodeURIComponent(query)}`);
                displayAllBooks(books, true); // Pass search results to displayAllBooks
            } catch (error) { 
                const container = document.getElementById('books-list-container'); // Corrected ID
                if (container) container.innerHTML = `<tr><td colspan="7" class="py-4 text-center text-red-500">Error searching books.</td></tr>`;
            }
        }
        async function updateBookStock(bookId, change, btnElement) { try { btnElement.disabled = true; const result = await fetchAPI(`/api/books/${bookId}/stock`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ stockChange: change }) }); showToast(`Stock for book ${bookId} updated. New stock: ${result.newStock}`, 'success'); displayAllBooks(); updateKpis(); checkAlerts(); } catch (error) { } finally { btnElement.disabled = false; } }
        async function updateBookStockByInput(bookId, btnElement) { const inputElement = document.querySelector(`.stock-change-input-${bookId}`); const change = parseInt(inputElement.value); if (isNaN(change)) { showToast('Please enter a valid number for stock change.', 'error'); return; } await updateBookStock(bookId, change, btnElement); inputElement.value = ''; }
        
        // --- Customer Management ---
        async function showModifyCustomerForm() {
            const customerId = prompt("Enter CustomerID to modify:");
            if (customerId && !isNaN(customerId)) {
                try {
                    const customer = await fetchAPI(`/api/customers/${customerId}`); // Needs GET /api/customers/:id
                    if (customer) {
                        document.getElementById('addCustomerFormSection').classList.remove('hidden');
                        document.querySelector('#addCustomerFormSection h3').textContent = 'Edit Customer';
                        document.getElementById('customerIdForEdit').value = customer.CustomerID;
                        document.getElementById('custFirstName').value = customer.FirstName;
                        document.getElementById('custLastName').value = customer.LastName;
                        document.getElementById('custEmail').value = customer.Email;
                        document.getElementById('custPhone').value = customer.Phone || '';
                        document.getElementById('custShippingAddress').value = customer.ShippingAddress || '';
                        document.getElementById('custBillingAddress').value = customer.BillingAddress || '';
                        // Password field typically left blank for updates unless changing
                        document.getElementById('custPassword').value = ''; 
                    }
                } catch (e) { /* handled by fetchAPI */ }
            } else if (customerId) { showToast("Invalid Customer ID", "error"); }
        }
        async function showDeleteCustomerForm() {
            const customerId = prompt("Enter CustomerID to delete:");
             if (customerId && !isNaN(customerId)) {
                if (confirm(`Are you sure you want to delete Customer ID ${customerId}?`)) {
                    try {
                        await fetchAPI(`/api/customers/${customerId}`, { method: 'DELETE' }); // Needs DELETE /api/customers/:id
                        showToast('Customer deleted successfully!', 'success');
                        displayAllCustomers(); updateKpis();
                    } catch (e) { /* handled by fetchAPI */ }
                }
            } else if (customerId) { showToast("Invalid Customer ID", "error"); }
        }
        
        async function handleAddOrUpdateCustomer(e) { 
            e.preventDefault(); 
            const formData = new FormData(e.target); 
            const customerData = Object.fromEntries(formData.entries()); 
            const customerId = customerData.customerIdForEdit;

            if (!customerData.firstName || !customerData.lastName || !customerData.email) { 
                showToast('First Name, Last Name, and Email are required.', 'error'); return; 
            } 
            if (customerId && !customerData.password) {
                delete customerData.password;
            }
            
            const url = customerId ? `/api/customers/${customerId}` : '/api/customers';
            const method = customerId ? 'PUT' : 'POST';
            
            try { 
                const savedCustomer = await fetchAPI(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(customerData) }); 
                const action = customerId ? 'updated' : 'added';
                showToast(`Customer ${action} successfully!`, 'success'); 
                
                if (typeof createNewNotification === 'function') {
                    const customerDisplayName = `${customerData.firstName} ${customerData.lastName}`;
                    const displayId = customerId || (savedCustomer && savedCustomer.CustomerID ? savedCustomer.CustomerID : 'New');
                    createNewNotification(
                        `Customer ${action}: ${customerDisplayName.substring(0, 30)}...`,
                        `Customer "${customerDisplayName}" (ID: ${displayId}) has been successfully ${action}. Email: ${customerData.email}.`,
                        'success',
                        '#customers-panel'
                    );
                }
                e.target.reset(); 
                document.getElementById('addCustomerFormSection').classList.add('hidden'); 
                document.getElementById('customerIdForEdit').value = '';
                displayAllCustomers(); 
                updateKpis(); 
                fetchCustomersForDropdown(true);
            } catch (error) { /* Handled by fetchAPI */ } 
        }

        async function showDeleteCustomerForm() {
            const customerId = prompt("Enter CustomerID to delete:");
             if (customerId && !isNaN(customerId)) {
                let customerName = `Customer ID ${customerId}`;
                try {
                    const cust = await fetchAPI(`/api/customers/${customerId}`);
                    if (cust && cust.FirstName) customerName = `${cust.FirstName} ${cust.LastName}`;
                } catch (fetchError) { console.warn("Could not fetch customer details for delete notification:", fetchError); }

                if (confirm(`Are you sure you want to delete ${customerName}?`)) {
                    try {
                        await fetchAPI(`/api/customers/${customerId}`, { method: 'DELETE' });
                        showToast('Customer deleted successfully!', 'success');
                        if (typeof createNewNotification === 'function') {
                            createNewNotification(
                                `Customer Deleted: ${customerName.substring(0,30)}...`,
                                `The customer "${customerName}" has been deleted.`,
                                'info',
                                '#customers-panel'
                            );
                        }
                        displayAllCustomers(); updateKpis();
                    } catch (e) { /* handled by fetchAPI */ }
                }
            } else if (customerId) { showToast("Invalid Customer ID", "error"); }
        }


        async function displayAllCustomers(customersToDisplay = null) { 
            const tbody = document.getElementById('customers-tbody'); 
            if(!tbody) return; 
            tbody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-gray-500">Loading customers...</td></tr>`; 
            try { 
                const customers = customersToDisplay || await fetchCustomersForDropdown(); 
                if (!customers || customers.length === 0) { 
                    tbody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-gray-500">${customersToDisplay ? 'No customers found matching search.' : 'No customers found.'}</td></tr>`; 
                    return; 
                } 
                tbody.innerHTML = customers.map(cust => ` 
                    <tr class="table-row border-b text-sm"> 
                        <td class="py-3 px-2">${cust.CustomerID}</td> 
                        <td class="py-3 px-2">${cust.FirstName} ${cust.LastName}</td> 
                        <td class="py-3 px-2">${cust.Email}</td> 
                        <td class="py-3 px-2">${cust.TotalOrders || 0}</td> 
                        <td class="py-3 px-2 whitespace-nowrap"> 
                            <button class="text-blue-600 hover:text-blue-800 mr-1 p-1 text-xs" title="Edit Customer" onclick="openEditCustomerModal(${cust.CustomerID})"><i class="fas fa-edit"></i></button>
                            <button class="text-red-600 hover:text-red-800 mr-2 p-1 text-xs" title="Delete Customer" onclick="confirmDeleteCustomer(${cust.CustomerID}, '${cust.FirstName} ${cust.LastName}')"><i class="fas fa-trash"></i></button>
                            <button class="text-blue-500 hover:text-blue-700 text-xs" onclick="viewCustomerOrders(${cust.CustomerID}, '${cust.FirstName} ${cust.LastName}')">View Orders</button> 
                        </td> 
                    </tr>`).join(''); 
            } catch (error) { 
                tbody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-red-500">Error loading customers.</td></tr>`; 
            } 
        }
        async function openEditCustomerModal(customerId) {
            showModifyCustomerForm(); // Call the existing prompt-based one or implement full modal
            // For full modal, you'd fetch data and populate:
            // const customer = await fetchAPI(`/api/customers/${customerId}`);
            // ... populate form ...
        }
        async function confirmDeleteCustomer(customerId, customerName) {
             if (confirm(`Are you sure you want to delete customer ${customerName} (ID: ${customerId})?`)) {
                try {
                    await fetchAPI(`/api/customers/${customerId}`, { method: 'DELETE' });
                    showToast('Customer deleted successfully!', 'success');
                    displayAllCustomers();
                } catch (error) { /* fetchAPI shows toast */ }
            }
        }
        async function searchCustomers() {
            const criteria = document.getElementById('customers-search-criteria').value;
            const query = document.getElementById('customers-search-query').value.trim();
            console.log('searchCustomers:', criteria, query);
             if (!query) { displayAllCustomers(); return; }
            try {
                const customers = await fetchAPI(`/api/customers/search?criteria=${encodeURIComponent(criteria)}&query=${encodeURIComponent(query)}`);
                displayAllCustomers(customers);
            } catch (error) { /* ... */ }

        }
        async function viewCustomerOrders(customerId, customerName) { showToast(`Fetching orders for ${customerName}...`, 'info'); try { const orders = await fetchAPI(`/api/customers/${customerId}/orders`); let ordersHtml = `<div class="p-4 border mt-2 rounded bg-gray-50"><h3 class="text-lg font-semibold mb-2">Orders for ${customerName} (ID: ${customerId})</h3>`; if (!orders || orders.length === 0) { ordersHtml += `<p>No orders found for this customer.</p>`; } else { ordersHtml += `<ul class="list-disc pl-5">`; orders.forEach(order => { ordersHtml += `<li>Order ID: ${order.OrderID}, Date: ${new Date(order.OrderDate).toLocaleDateString()}, Amount: $${Number(order.TotalAmount||0).toFixed(2)}, Status: ${order.Status}</li>`; }); ordersHtml += `</ul>`; } ordersHtml += `</div>`; const tempDiv = document.createElement('div'); tempDiv.innerHTML = ordersHtml; const currentPanel = document.querySelector('.content-panel.active .card'); if(currentPanel) { const oldOrders = currentPanel.querySelector('.customer-orders-display'); if(oldOrders) oldOrders.remove(); tempDiv.classList.add('customer-orders-display'); currentPanel.appendChild(tempDiv); } showToast(`Loaded ${orders.length} orders for ${customerName}. Check bottom of panel.`, 'success'); } catch (error) { showToast(`Failed to load orders for ${customerName}.`, 'error'); } }
        
        // --- Order Management ---
        function showModifyOrderForm() {
            const orderId = prompt("Enter OrderID to modify status:");
            if (orderId && !isNaN(orderId)) {
                const newStatus = prompt(`Enter new status for OrderID ${orderId} (Pending, Processing, Shipped, Completed, Cancelled):`);
                if (newStatus && ['Pending', 'Processing', 'Shipped', 'Completed', 'Cancelled'].includes(newStatus)) {
                    updateOrderStatus(orderId, newStatus, { disabled: false, value: newStatus }); // Mock select element for existing fn
                } else if (newStatus) {
                    showToast("Invalid status provided.", "error");
                }
            } else if (orderId) { showToast("Invalid Order ID.", "error"); }
        }
        function showCancelOrderForm() {
            const orderId = prompt("Enter OrderID to cancel:");
            if (orderId && !isNaN(orderId)) {
                if (confirm(`Are you sure you want to cancel OrderID ${orderId}?`)) {
                     updateOrderStatus(orderId, 'Cancelled', { disabled: false, value: 'Cancelled' });
                }
            } else if (orderId) { showToast("Invalid Order ID.", "error"); }
        }
        async function displayAllOrders(ordersToDisplay = null) { 
            const tbody = document.getElementById('all-orders-tbody'); 
            if(!tbody) return; 
            tbody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-gray-500">Loading orders...</td></tr>`; 
            try { 
                const orders = ordersToDisplay || await fetchAPI('/api/all-orders'); 
                if (!orders || orders.length === 0) { 
                    tbody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-gray-500">${ordersToDisplay ? 'No orders found matching search.' : 'No orders found.'}</td></tr>`; 
                    return; 
                } 
                tbody.innerHTML = orders.map(order => { const orderDate = order.OrderDate ? new Date(order.OrderDate).toLocaleDateString() : 'N/A'; return ` 
                    <tr class="table-row border-b text-sm"> 
                        <td class="py-3 px-2">${order.OrderID}</td> 
                        <td class="py-3 px-2">${order.CustomerName || 'N/A'}</td> 
                        <td class="py-3 px-2">${orderDate}</td> 
                        <td class="py-3 px-2">$${Number(order.amount || 0).toFixed(2)}</td> 
                        <td class="py-3 px-2"> 
                            <select class="p-1 border rounded text-xs bg-white" onchange="updateOrderStatus(${order.OrderID}, this.value, this)"> 
                                ${['Pending', 'Processing', 'Shipped', 'Completed', 'Cancelled'].map(s => `<option value="${s}" ${order.Status === s ? 'selected' : ''}>${s}</option>`).join('')} 
                            </select> 
                        </td> 
                        <td class="py-3 px-2"><button class="text-blue-500 hover:text-blue-700 text-xs" onclick="viewOrderDetails(${order.OrderID})">Details</button></td> 
                    </tr>`}).join(''); 
            } catch (error) { 
                tbody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-red-500">Error loading orders.</td></tr>`; 
            } 
        }
        async function searchOrders() {
            const criteria = document.getElementById('orders-search-criteria').value;
            const query = document.getElementById('orders-search-query').value.trim();
            if (!query) { displayAllOrders(); return; }
            try {
                const orders = await fetchAPI(`/api/orders/search?criteria=${encodeURIComponent(criteria)}&query=${encodeURIComponent(query)}`);
                displayAllOrders(orders);
            } catch (error) { /* ... */ }
        }
        
        async function viewOrderDetails(orderId) {
            showToast(`Fetching details for Order ID: ${orderId}...`, 'info');

            let targetDetailsArea = null;
            let closeButtonOnClickAction = '';

            // Determine which panel is active and select the correct details area
            const dashboardPanel = document.getElementById('dashboard-panel');
            const ordersPanel = document.getElementById('orders-panel');

            if (dashboardPanel && dashboardPanel.classList.contains('active')) {
                targetDetailsArea = document.getElementById('dashboardOrderDetailsArea');
                if (targetDetailsArea) {
                    closeButtonOnClickAction = `document.getElementById('dashboardOrderDetailsArea').classList.add('hidden'); document.getElementById('dashboardOrderDetailsArea').innerHTML='';`;
                }
            } else if (ordersPanel && ordersPanel.classList.contains('active')) {
                targetDetailsArea = document.getElementById('ordersPanelDetailsArea');
                if (targetDetailsArea) {
                    closeButtonOnClickAction = `document.getElementById('ordersPanelDetailsArea').classList.add('hidden'); document.getElementById('ordersPanelDetailsArea').innerHTML='';`;
                }
            }

            if (!targetDetailsArea) {
                console.warn('viewOrderDetails called, but no active panel with a details area found or the area itself is missing.');
                showToast('Cannot display order details: display area not found for the current panel.', 'error');
                return;
            }

            try {
                const details = await fetchAPI(`/api/orders/${orderId}/details`); // Your existing API call
                let detailsHtml = `<h4 class="text-md font-semibold mb-2">Details for Order ID: ${orderId}</h4>`;

                if (!details || details.length === 0) {
                    detailsHtml += `<p>No items found for this order.</p>`;
                } else {
                    detailsHtml += `<ul class="list-disc pl-5 text-sm">`;
                    details.forEach(item => {
                        detailsHtml += `<li>${item.Quantity} x "${item.Title}" (@ $${Number(item.Price || 0).toFixed(2)})</li>`;
                    });
                    detailsHtml += `</ul>`;
                }
                // Add a close button for the details area
                if (closeButtonOnClickAction) {
                    detailsHtml += `<button onclick="${closeButtonOnClickAction}" class="btn-secondary text-xs px-2 py-1 rounded mt-3">Close Details</button>`;
                }


                targetDetailsArea.innerHTML = detailsHtml;
                targetDetailsArea.classList.remove('hidden'); // Make the details area visible
                targetDetailsArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); // Scroll to the details

                showToast(`Loaded details for Order ID: ${orderId}.`, 'success');
            } catch (error) {
                // fetchAPI already shows a toast, but you can add more specific error display
                if (targetDetailsArea) {
                    targetDetailsArea.innerHTML = `<p class="text-red-500">Failed to load details for Order ID: ${orderId}.</p>`;
                    if (!targetDetailsArea.classList.contains('hidden')) { // If it was made visible before error
                        targetDetailsArea.classList.remove('hidden'); // Ensure it's visible to show error
                    }
                }
                console.error(`Error in viewOrderDetails for ${orderId}:`, error);
            }
        }
        
        async function updateOrderStatus(orderId, newStatus, selectElement) { 
            selectElement.disabled = true; 
            try { 
                await fetchAPI(`/api/orders/${orderId}/status`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) }); 
                showToast(`Order ${orderId} status updated to ${newStatus}`, 'success'); 
                
                if (typeof createNewNotification === 'function') {
                    createNewNotification(
                        `Order Status Update: #${orderId}`,
                        `Order ID ${orderId} status has been changed to "${newStatus}".`,
                        'info',
                        `#orders-panel` // Ideally, link to the specific order if panel supports it
                    );
                }
                
                displayAllOrders(); 
                updateKpis(); 
            } catch (error) { 
                selectElement.value = Array.from(selectElement.options).find(opt => opt.selected).value; 
            } finally { 
                selectElement.disabled = false; 
            } 
        }


        async function populateOrderFormDropdowns() { const customerSelect = document.getElementById('orderCustomerId'); if(!customerSelect) return; customerSelect.innerHTML = '<option value="">Loading Customers...</option>'; try { const customers = await fetchCustomersForDropdown(); customerSelect.innerHTML = '<option value="">Select a Customer</option>'; customers.forEach(cust => customerSelect.add(new Option(`${cust.FirstName} ${cust.LastName} (ID: ${cust.CustomerID})`, cust.CustomerID))); await fetchBooksForDropdown(true); } catch (error) { customerSelect.innerHTML = '<option value="">Error loading customers</option>'; } }
        function addOrderItemRow() { orderItemCounter++; const container = document.getElementById('orderItemsContainer'); if(!container) return; const itemRow = document.createElement('div'); itemRow.className = 'grid grid-cols-3 gap-2 items-center'; itemRow.innerHTML = ` <div> <label for="orderBookId_${orderItemCounter}" class="sr-only">Book</label> <select name="items[${orderItemCounter-1}][bookId]" id="orderBookId_${orderItemCounter}" required class="block w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm bg-white"> <option value="">Loading Books...</option> </select> </div> <div> <label for="orderQuantity_${orderItemCounter}" class="sr-only">Quantity</label> <input type="number" name="items[${orderItemCounter-1}][quantity]" id="orderQuantity_${orderItemCounter}" min="1" value="1" required class="block w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm"> </div> <button type="button" class="text-red-500 hover:text-red-700 text-sm" onclick="this.parentElement.remove()">Remove</button> `; container.appendChild(itemRow); const bookSelect = itemRow.querySelector('select'); bookSelect.innerHTML = '<option value="">Select a Book</option>'; cachedBooksInStock.forEach(book => bookSelect.add(new Option(`${book.Title} (Stock: ${book.Stock}) - $${book.Price}`, book.BookID))); }
       
        async function handleCreateOrder(e) { 
            e.preventDefault(); 
            const formData = new FormData(e.target); 
            const orderData = { 
                customerId: parseInt(formData.get('customerId')), 
                paymentMethod: formData.get('paymentMethod'), 
                items: [] 
            };
            const itemElements = document.getElementById('orderItemsContainer').children; 
            for (let i = 0; i < itemElements.length; i++) { 
                const bookId = itemElements[i].querySelector('select[name*="[bookId]"]').value; 
                const quantity = itemElements[i].querySelector('input[name*="[quantity]"]').value; 
                if (bookId && quantity) { 
                    orderData.items.push({ bookId: parseInt(bookId), quantity: parseInt(quantity) }); 
                } 
            } 
            if (!orderData.customerId || !orderData.paymentMethod || orderData.items.length === 0) { 
                showToast('Customer, payment method, and at least one item are required.', 'error'); return; 
            } 
            if (orderData.items.some(item => item.quantity <= 0)) { 
                showToast('Item quantity must be greater than 0.', 'error'); return; 
            } 
            try { 
                const placedOrder = await fetchAPI('/api/orders', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(orderData) }); 
                showToast('Order placed successfully!', 'success'); 
                
                if (typeof createNewNotification === 'function') {
                    // To get customer name, we might need to find it from cachedCustomers
                    const customer = cachedCustomers.find(c => c.CustomerID === orderData.customerId);
                    const customerName = customer ? `${customer.FirstName} ${customer.LastName}` : `Customer ID ${orderData.customerId}`;
                    // The actual OrderID would ideally come from `placedOrder` response. Assuming it's not available for now.
                    createNewNotification(
                        `New Order Placed`,
                        `A new order has been placed by ${customerName}. Total items: ${orderData.items.length}. Payment: ${orderData.paymentMethod}.`,
                        'success',
                        '#orders-panel' // Or a link to the specific order if ID was available: `#orders-panel?orderId=${placedOrder.OrderID}`
                    );
                }

                e.target.reset(); 
                document.getElementById('orderItemsContainer').innerHTML = ''; 
                document.getElementById('createOrderFormSection').classList.add('hidden'); 
                displayAllOrders(); 
                updateKpis(); 
                displayAllBooks(); // Refresh book stock display
                checkAlerts(); 
            } catch (error) { /* Handled by fetchAPI */ } 
        }


        
        
        // --- Genre Management ---
        function showAddGenreForm() {
            document.getElementById('genreIdInput').value = ''; // Clear ID for add mode
            document.getElementById('genreNameInput').value = '';
            document.getElementById('add-genre-form').classList.remove('hidden');
            document.querySelector('#add-genre-form h3').textContent = 'Add New Genre';
        }
        function editGenre(genreId, genreName) {
            document.getElementById('genreIdInput').value = genreId;
            document.getElementById('genreNameInput').value = genreName;
            document.getElementById('add-genre-form').classList.remove('hidden');
            document.querySelector('#add-genre-form h3').textContent = 'Edit Genre';
            document.getElementById('genreNameInput').focus();
        }
        function cancelGenreEdit() {
            document.getElementById('add-genre-form').classList.add('hidden');
            document.getElementById('genreForm').reset();
        }
       
        async function handleGenreFormSubmit(event) {
            event.preventDefault();
            const genreId = document.getElementById('genreIdInput').value;
            const genreName = document.getElementById('genreNameInput').value.trim();

            if (!genreName) { showToast('Genre name is required.', 'error'); return; }

            const url = '/api/genres'; 
            const method = 'POST'; 
            const body = { name: genreName };
            if (genreId) { body.id = parseInt(genreId); } 

            try {
                await fetchAPI(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const action = genreId ? 'updated' : 'added';
                showToast(`Genre ${action} successfully!`, 'success');

                if (typeof createNewNotification === 'function') {
                    createNewNotification(
                        `Genre ${action}: ${genreName}`,
                        `The genre "${genreName}" has been successfully ${action}.`,
                        'success',
                        '#genres-panel'
                    );
                }
                cancelGenreEdit();
                displayGenres();
            } catch (error) { /* fetchAPI handles toast */ }
        }
        
        async function deleteGenre(genreId, genreName) {
            if (!confirm(`Are you sure you want to delete the genre "${genreName}" (ID: ${genreId})?`)) return;
            try {
                await fetchAPI(`/api/genres/${genreId}`, { method: 'DELETE' });
                showToast('Genre deleted successfully!', 'success');
                if (typeof createNewNotification === 'function') {
                    createNewNotification(
                        `Genre Deleted: ${genreName}`,
                        `The genre "${genreName}" has been deleted.`,
                        'info',
                        '#genres-panel'
                    );
                }
                displayGenres();
            } catch (error) { /* fetchAPI handles toast */ }
        }

        async function displayGenres(genresToDisplay = null) {
            const ul = document.getElementById('genre-list-ul'); 
            if(!ul) return; 
            ul.innerHTML = `<li class="text-gray-500 py-2">Loading genres...</li>`; 
            try { 
                const genres = genresToDisplay || await fetchAPI('/api/genres'); 
                if (!genres || genres.length === 0) { 
                    ul.innerHTML = `<li class="text-gray-500 py-2">${genresToDisplay ? 'No genres found matching search.' : 'No genres found. Click "Add New Genre" to start.'}</li>`; 
                    return; 
                } 
                ul.innerHTML = genres.map(genre => `
                    <li class="py-2 flex justify-between items-center">
                        <span>${genre.Name} (ID: ${genre.GenreID})</span>
                        <div>
                            <button class="btn-secondary text-xs px-2 py-1 rounded" onclick="editGenre(${genre.GenreID}, '${genre.Name.replace(/'/g, "\\'")}')">Modify</button>
                            <button class="btn-danger bg-red-500 text-white text-xs px-2 py-1 rounded ml-1" onclick="deleteGenre(${genre.GenreID}, '${genre.Name.replace(/'/g, "\\'")}')">Delete</button>
                        </div>
                    </li>`).join(''); 
            } catch (error) { 
                ul.innerHTML = `<li class="text-red-500 py-2">Error loading genres.</li>`; 
            } 
        }
        async function searchGenres() {
            const query = document.getElementById('genres-search-query').value.trim();
            if (!query) { displayGenres(); return; }
            try {
                // Assuming server endpoint `/api/genres/search?name=query`
                const genres = await fetchAPI(`/api/genres/search?name=${encodeURIComponent(query)}`);
                displayGenres(genres);
            } catch (error) {
                const ul = document.getElementById('genre-list-ul');
                if(ul) ul.innerHTML = `<li class="text-red-500 py-2">Error searching genres.</li>`;
            }
        }

        // --- Author Management ---
        async function showModifyAuthorForm() {
            const authorId = prompt("Enter AuthorID to modify:");
            if (authorId && !isNaN(authorId)) {
                try {
                    const author = await fetchAPI(`/api/authors/${authorId}`); // Needs GET /api/authors/:id
                    if (author) {
                        document.getElementById('addAuthorFormSection').classList.remove('hidden');
                        document.querySelector('#addAuthorFormSection h3').textContent = 'Edit Author';
                        document.getElementById('authorIdForEdit').value = author.AuthorID;
                        document.getElementById('authorName').value = author.Name;
                        document.getElementById('authorDOB').value = author.DOB ? new Date(author.DOB).toISOString().split('T')[0] : '';
                    }
                } catch (e) { /* handled */ }
            } else if (authorId) { showToast("Invalid Author ID", "error"); }
        }
        async function showDeleteAuthorForm() {
            const authorId = prompt("Enter AuthorID to delete:");
             if (authorId && !isNaN(authorId)) {
                let authorName = `Author ID ${authorId}`;
                try {
                    const author = await fetchAPI(`/api/authors/${authorId}`);
                    if (author && author.Name) authorName = author.Name;
                } catch (fetchError) { console.warn("Could not fetch author details for delete notification:", fetchError); }

                if (confirm(`Are you sure you want to delete ${authorName}?`)) {
                    try {
                        await fetchAPI(`/api/authors/${authorId}`, { method: 'DELETE' }); 
                        showToast('Author deleted successfully!', 'success');
                        if (typeof createNewNotification === 'function') {
                            createNewNotification(
                                `Author Deleted: ${authorName}`,
                                `The author "${authorName}" has been deleted.`,
                                'info',
                                '#authors-panel'
                            );
                        }
                        displayAuthorsList(); fetchAuthors(true); 
                    } catch (e) { /* handled */ }
                }
            } else if (authorId) { showToast("Invalid Author ID", "error"); }
        }

        async function handleAddOrUpdateAuthor(e) { 
            e.preventDefault(); 
            const formData = new FormData(e.target); 
            const authorData = { name: formData.get('name'), dob: formData.get('dob') || null }; 
            const authorId = formData.get('authorIdForEdit');

            if (!authorData.name) { showToast('Author name is required.', 'error'); return; } 
            
            const url = authorId ? `/api/authors/${authorId}` : '/api/authors';
            const method = authorId ? 'PUT' : 'POST';

            try { 
                await fetchAPI(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(authorData) }); 
                const action = authorId ? 'updated' : 'added';
                showToast(`Author ${action} successfully!`, 'success'); 

                if (typeof createNewNotification === 'function') {
                    createNewNotification(
                        `Author ${action}: ${authorData.name}`,
                        `Author "${authorData.name}" has been successfully ${action}.`,
                        'success',
                        '#authors-panel'
                    );
                }
                e.target.reset(); 
                document.getElementById('addAuthorFormSection').classList.add('hidden'); 
                document.getElementById('authorIdForEdit').value = '';
                displayAuthorsList(); 
                fetchAuthors(true); 
            } catch (error) { /* Handled */ } 
        }
        async function displayAuthorsList(authorsToDisplay = null) { 
            const tbody = document.getElementById('authors-tbody'); 
            if(!tbody) return; 
            tbody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-500">Loading authors...</td></tr>`; 
            try { 
                const authors = authorsToDisplay || await fetchAuthors(); 
                if (!authors || authors.length === 0) { 
                    tbody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-500">${authorsToDisplay ? 'No authors found matching search.' : 'No authors found.'}</td></tr>`; 
                    return; 
                } 
                tbody.innerHTML = authors.map(author => ` 
                    <tr class="table-row border-b text-sm"> 
                        <td class="py-3 px-2">${author.AuthorID}</td> 
                        <td class="py-3 px-2">${author.Name}</td> 
                        <td class="py-3 px-2">${author.DOB ? new Date(author.DOB).toLocaleDateString() : 'N/A'}</td> 
                        <td class="py-3 px-2 whitespace-nowrap">
                           <button class="text-blue-600 hover:text-blue-800 mr-1 p-1 text-xs" title="Edit Author" onclick="openEditAuthorModal(${author.AuthorID})"><i class="fas fa-edit"></i></button>
                           <button class="text-red-600 hover:text-red-800 p-1 text-xs" title="Delete Author" onclick="confirmDeleteAuthor(${author.AuthorID}, '${author.Name.replace(/'/g, "\\'")}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`).join(''); 
            } catch (error) { 
                tbody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-red-500">Error loading authors.</td></tr>`; 
            } 
        }
        async function openEditAuthorModal(authorId) { showModifyAuthorForm(); /* Or implement full modal */ }
        async function confirmDeleteAuthor(authorId, name) {
            if(confirm(`Are you sure you want to delete author ${name} (ID: ${authorId})?`)) showDeleteAuthorForm(); /* Or call API directly */
        }
        async function searchAuthors() {
            const criteria = document.getElementById('authors-search-criteria').value;
            const query = document.getElementById('authors-search-query').value.trim();
            if (!query) { displayAuthorsList(); return; }
            try {
                const authors = await fetchAPI(`/api/authors/search?criteria=${encodeURIComponent(criteria)}&query=${encodeURIComponent(query)}`);
                displayAuthorsList(authors);
            } catch (error) { /* ... */ }
        }

        // --- Publisher Management ---
        async function showModifyPublisherForm() {
            const publisherId = prompt("Enter PublisherID to modify:");
            if (publisherId && !isNaN(publisherId)) {
                try {
                    const publisher = await fetchAPI(`/api/publishers/${publisherId}`); // Needs GET /api/publishers/:id
                    if(publisher) {
                        document.getElementById('addPublisherFormSection').classList.remove('hidden');
                        document.querySelector('#addPublisherFormSection h3').textContent = 'Edit Publisher';
                        document.getElementById('publisherIdForEdit').value = publisher.PublisherID;
                        document.getElementById('publisherName').value = publisher.Name;
                        document.getElementById('publisherContact').value = publisher.Contact || '';
                        document.getElementById('publisherAddress').value = publisher.Address || '';
                    }
                } catch(e) {/* handled */}
            } else if(publisherId) { showToast("Invalid Publisher ID", "error");}
        }
        
         async function showDeletePublisherForm() {
            const publisherId = prompt("Enter PublisherID to delete:");
            if (publisherId && !isNaN(publisherId)) {
                let publisherName = `Publisher ID ${publisherId}`;
                try {
                    const pub = await fetchAPI(`/api/publishers/${publisherId}`);
                    if (pub && pub.Name) publisherName = pub.Name;
                } catch (fetchError) { console.warn("Could not fetch publisher details for delete notification:", fetchError); }

                if(confirm(`Are you sure you want to delete ${publisherName}?`)){
                    try {
                        await fetchAPI(`/api/publishers/${publisherId}`, {method: 'DELETE'}); 
                        showToast('Publisher deleted successfully!', 'success');
                        if (typeof createNewNotification === 'function') {
                            createNewNotification(
                                `Publisher Deleted: ${publisherName}`,
                                `The publisher "${publisherName}" has been deleted.`,
                                'info',
                                '#publishers-panel'
                            );
                        }
                        displayPublishersList(); fetchPublishers(true); 
                    } catch(e) {/* handled */}
                }
            } else if(publisherId) { showToast("Invalid Publisher ID", "error");}
        }

        async function handleAddOrUpdatePublisher(e) { 
            e.preventDefault(); 
            const formData = new FormData(e.target); 
            const publisherData = { name: formData.get('name'), address: formData.get('address') || null, contact: formData.get('contact') || null }; 
            const publisherId = formData.get('publisherIdForEdit');

            if (!publisherData.name) { showToast('Publisher name is required.', 'error'); return; } 
            
            const url = publisherId ? `/api/publishers/${publisherId}` : '/api/publishers';
            const method = publisherId ? 'PUT' : 'POST';
            
            try { 
                await fetchAPI(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(publisherData) }); 
                const action = publisherId ? 'updated' : 'added';
                showToast(`Publisher ${action} successfully!`, 'success'); 

                if (typeof createNewNotification === 'function') {
                    createNewNotification(
                        `Publisher ${action}: ${publisherData.name}`,
                        `Publisher "${publisherData.name}" has been successfully ${action}.`,
                        'success',
                        '#publishers-panel'
                    );
                }
                e.target.reset(); 
                document.getElementById('addPublisherFormSection').classList.add('hidden'); 
                document.getElementById('publisherIdForEdit').value = '';
                displayPublishersList(); 
                fetchPublishers(true); 
            } catch (error) { /* Handled */ } 
        }
        async function displayPublishersList(publishersToDisplay = null) { 
            const tbody = document.getElementById('publishers-tbody'); 
            if(!tbody) return; 
            tbody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-gray-500">Loading publishers...</td></tr>`; 
            try { 
                const publishers = publishersToDisplay || await fetchPublishers(); 
                if (!publishers || publishers.length === 0) { 
                    tbody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-gray-500">${publishersToDisplay ? 'No publishers found matching search.' : 'No publishers found.'}</td></tr>`; 
                    return; 
                } 
                tbody.innerHTML = publishers.map(pub => ` 
                    <tr class="table-row border-b text-sm"> 
                        <td class="py-3 px-2">${pub.PublisherID}</td> 
                        <td class="py-3 px-2">${pub.Name}</td> 
                        <td class="py-3 px-2">${pub.Address || 'N/A'}</td> 
                        <td class="py-3 px-2">${pub.Contact || 'N/A'}</td> 
                        <td class="py-3 px-2 whitespace-nowrap">
                           <button class="text-blue-600 hover:text-blue-800 mr-1 p-1 text-xs" title="Edit Publisher" onclick="openEditPublisherModal(${pub.PublisherID})"><i class="fas fa-edit"></i></button>
                           <button class="text-red-600 hover:text-red-800 p-1 text-xs" title="Delete Publisher" onclick="confirmDeletePublisher(${pub.PublisherID}, '${pub.Name.replace(/'/g, "\\'")}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`).join(''); 
            } catch (error) { 
                tbody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-red-500">Error loading publishers.</td></tr>`; 
            } 
        }
        async function openEditPublisherModal(publisherId) { showModifyPublisherForm(); /* Or implement full modal */ }
        async function confirmDeletePublisher(publisherId, name) {
            if(confirm(`Are you sure you want to delete publisher ${name} (ID: ${publisherId})?`)) showDeletePublisherForm(); /* Or call API directly */
        }
        async function searchPublishers() {
            const criteria = document.getElementById('publishers-search-criteria').value;
            const query = document.getElementById('publishers-search-query').value.trim();
            if (!query) { displayPublishersList(); return; }
            try {
                const publishers = await fetchAPI(`/api/publishers/search?criteria=${encodeURIComponent(criteria)}&query=${encodeURIComponent(query)}`);
                displayPublishersList(publishers);
            } catch (error) { /* ... */ }
        }

        // --- Admin User Management (Stubs) ---
        function showAddAdminForm() {
            document.getElementById('addAdminFormSection').classList.remove('hidden');
            document.getElementById('adminUserForm').reset();
            document.getElementById('adminIdForEdit').value = '';
            document.querySelector('#addAdminFormSection h3').textContent = 'Add New Admin User';
            showToast('Add Admin User: UI ready, API needed.', 'info');
        }
        function showModifyAdminForm() {
            const adminId = prompt("Enter Admin User ID to modify (fictional for now):");
            if(adminId) {
                showToast(`Modify Admin User ID ${adminId}: UI ready, API needed for fetch and update.`, 'info');
                // In real scenario: fetch admin data, populate form, show form.
                 document.getElementById('addAdminFormSection').classList.remove('hidden');
                 document.querySelector('#addAdminFormSection h3').textContent = 'Edit Admin User';
                 document.getElementById('adminIdForEdit').value = adminId; // For submission
            }
        }
        function showDeleteAdminForm() {
            const adminId = prompt("Enter Admin User ID to delete (fictional for now):");
            if(adminId && confirm(`Delete Admin User ID ${adminId}?`)) {
                 showToast(`Delete Admin User ID ${adminId}: API needed.`, 'info');
            }
        }
        async function handleAdminUserFormSubmit(event) {
            event.preventDefault();
            const adminId = document.getElementById('adminIdForEdit').value;
            // Collect form data...
            showToast(`Admin user form submitted for ID: ${adminId || 'NEW'}. API interaction needed.`, 'success');
            document.getElementById('addAdminFormSection').classList.add('hidden');
        }


        // --- Utility Functions ---
        async function fetchAuthors(forceRefresh = false) { if (!forceRefresh && cachedAuthors.length > 0) return cachedAuthors; try { cachedAuthors = await fetchAPI('/api/authors'); return cachedAuthors; } catch(e){ return []; } }
        async function fetchPublishers(forceRefresh = false) { if (!forceRefresh && cachedPublishers.length > 0) return cachedPublishers; try { cachedPublishers = await fetchAPI('/api/publishers'); return cachedPublishers; } catch(e){ return []; } }
        async function fetchCustomersForDropdown(forceRefresh = false) { if (!forceRefresh && cachedCustomers.length > 0) return cachedCustomers; try{ cachedCustomers = await fetchAPI('/api/customers'); return cachedCustomers; } catch(e) {return [];} }
        async function fetchBooksForDropdown(forceRefresh = false) { if (!forceRefresh && cachedBooksInStock.length > 0) return cachedBooksInStock; try{ cachedBooksInStock = await fetchAPI('/api/books/in-stock'); return cachedBooksInStock; } catch(e) {return [];} }
        function getOrderStatusClass(status) { const classes = { 'Completed': 'bg-green-100 text-green-800', 'Processing': 'bg-yellow-100 text-yellow-800', 'Shipped': 'bg-blue-100 text-blue-800', 'Pending': 'bg-orange-100 text-orange-800', 'Cancelled': 'bg-red-100 text-red-800', default: 'bg-gray-100 text-gray-800' }; return classes[status] || classes.default; }
        function getStockStatusClass(stock) { if (stock <= 0) return 'bg-red-100 text-red-800'; if (stock < LOW_STOCK_THRESHOLD) return 'bg-yellow-100 text-yellow-800'; if (stock < LOW_STOCK_THRESHOLD * 3) return 'bg-blue-100 text-blue-800'; return 'bg-green-100 text-green-800'; }
        
        async function handleLogin(event) { // This is the API-based login
            event.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;

            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                if (response.ok) {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    showToast('Login successful!', 'success');
                    showDashboard();
                    loginForm.reset(); // Reset form on successful login
                } else {
                    const errorData = await response.json();
                    showToast(errorData.error || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login API call error:', error);
                showToast('Network error during login.', 'error');
            }
        }

    </script>
</body>
</html>